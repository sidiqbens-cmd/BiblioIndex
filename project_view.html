<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 5px; font-size: 11px; }
        .project-bar { background: #24292e; color: #fff; padding: 5px 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .compact-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #fff; padding: 10px; border: 1px solid #ccc; }
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 10px; color: #333; font-weight: bold; margin-bottom: 2px; text-align: center; }
        input, select { border: 1px solid #bbb; padding: 2px; font-size: 12px; height: 22px; text-align: right; }
        .actions { margin: 8px 0; display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
        .btn { padding: 5px 12px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-weight: bold; font-size: 11px; }
        .btn-save { background: #28a745; } .btn-excel { background: #17a2b8; } .btn-word { background: #007bff; }
        .preview-table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 4px; text-align: right; }
    </style>
</head>
<body>

<div class="project-bar">
    <div><strong>الفهرس الليبي الموحد</strong> | المشروع: <span id="activeProjectLabel" style="color:#ffc107"></span></div>
    <div style="display:flex; gap:10px;">
        <button onclick="createNewProject()" class="btn btn-save">+ مشروع جديد</button>
    </div>
</div>

<form id="biblioForm">
    <div class="compact-grid">
        <div class="field-group"><label>رأس الموضوع</label><input type="text" id="subject" class="in"></div>
        <div class="field-group"><label>إحالة انظر</label><input type="text" id="see" class="in"></div>
        <div class="field-group"><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in"></div>
        <div class="field-group"><label>المؤلف</label><input type="text" id="author" class="in"></div>
        <div class="field-group"><label>العنوان</label><input type="text" id="title" class="in"></div>
        <div class="field-group"><label>المشاركون/المترجمون</label><input type="text" id="collab" class="in"></div>
    </div>
    <div class="compact-grid" style="margin-top:2px;">
        <div class="field-group"><label>الطبعة</label><input type="text" id="edition" class="in"></div>
        <div class="field-group"><label>مكان النشر</label><input type="text" id="place" class="in"></div>
        <div class="field-group"><label>الناشر</label><input type="text" id="publisher" class="in"></div>
        <div class="field-group"><label>السنة</label><input type="text" id="year" class="in"></div>
        <div class="field-group"><label>صفحات</label><input type="text" id="pages" class="in"></div>
        <div class="field-group"><label>السلسلة</label><input type="text" id="series" class="in"></div>
    </div>
    <div class="compact-grid" style="margin-top:2px; grid-template-columns: repeat(7, 1fr);">
        <div class="field-group"><label>عنوان أصلي</label><input type="text" id="orig_title" class="in"></div>
        <div class="field-group"><label>مؤلف أصلي</label><input type="text" id="orig_author" class="in"></div>
        <div class="field-group"><label>جهة الإصدار</label><input type="text" id="org" class="in"></div>
        <div class="field-group"><label>عدد المؤلفين</label><input type="number" id="count" class="in"></div>
        <div class="field-group"><label>التبعية المؤسسية</label><input type="text" id="affil" class="in"></div>
        <div class="field-group"><label>الدولة</label><input type="text" id="country" class="in"></div>
        <div class="field-group">
            <label>النوع</label>
            <select id="type" class="in">
                <option value="كتاب">كتاب</option>
                <option value="مقالة">مقالة</option>
                <option value="فصل">فصل</option>
                <option value="مؤتمر">مؤتمر</option>
                <option value="كتيب">كتيب</option>
                <option value="ماجستير">ماجستير</option>
                <option value="دكتوراه">دكتوراه</option>
            </select>
        </div>
    </div>
</form>

<div class="actions">
    <button class="btn btn-save" onclick="saveData()">حفظ (Enter)</button>
    <button class="btn btn-excel" onclick="exportToExcel()">تصدير Excel</button>
    <button class="btn btn-excel" style="background:#6f42c1" onclick="document.getElementById('importFile').click()">استيراد Excel</button>
    <input type="file" id="importFile" style="display:none" onchange="importFromExcel(event)">
    <button class="btn btn-word" onclick="previewFullList()">معاينة القائمة (Word)</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('author')">كشاف المؤلفين</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('collab')">كشاف المترجمين</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('title')">كشاف العناوين</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('orig_title')">كشاف العنوان الأصلي</button>
</div>

<table class="preview-table">
    <thead><tr style="background:#eee"><th>ت</th><th>رأس الموضوع</th><th>البيان الببليوغرافي</th><th>الإجراء</th></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
let currentProj = localStorage.getItem('lib_active_proj') || 'تجربة 1';
let records = JSON.parse(localStorage.getItem('recs_' + currentProj)) || [];
let editIdx = -1;

function cleanForSort(str) {
    if (!str) return "";
    return str.trim().replace(/^ال(?=[^ل])/, "").replace(/[أإآ]/g, "ا").replace(/[ى]/g, "ي");
}

function saveData() {
    let data = {}; document.querySelectorAll('.in').forEach(f => data[f.id] = f.value.trim());
    if(!data.subject) return alert("الرأس مطلوب");
    if(editIdx > -1) records[editIdx] = data; else records.push(data);
    editIdx = -1; sortData(); updateUI(); document.getElementById('biblioForm').reset();
}

function sortData() { 
    records.sort((a,b) => cleanForSort(a.subject).localeCompare(cleanForSort(b.subject),'ar')); 
}

function formatEntry(r) {
    let p = [];
    if(r.author) p.push(`<span style="font-weight:bold">${r.author}</span>`);
    if(r.title) p.push(`. <span style="${!r.author?'font-weight:bold':''}">${r.title}</span>`);
    if(r.collab) p.push(`؛ ${r.collab}`);
    if(r.edition) p.push(`. - ط ${r.edition}`);
    if(r.place || r.publisher || r.year) {
        let pub = ". - ";
        if(r.place) pub += r.place;
        if(r.publisher) pub += ": " + r.publisher;
        if(r.year) pub += "، " + r.year;
        p.push(pub);
    }
    if(r.pages) p.push(`. - ص ص ${r.pages}`);
    return p.join('').replace(/^\. /, "");
}

function updateUI() {
    localStorage.setItem('recs_'+currentProj, JSON.stringify(records));
    let h = ''; let s = 1;
    records.forEach((r,i) => { 
        h += `<tr><td>${r.see||r.see_also?'--':s++}</td><td style="color:blue; cursor:pointer" onclick="editRec(${i})">${r.subject}</td><td>${formatEntry(r)}</td><td><button onclick="editRec(${i})">تعديل</button></td></tr>`; 
    });
    document.getElementById('tableBody').innerHTML = h;
}

function previewFullList() {
    let win = window.open('', '', 'width=900,height=700');
    let serial = 1; let lastSubject = "";
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; font-size:12pt;">`;
    records.forEach(r => {
        if(r.subject !== lastSubject) {
            content += `<div style="text-align:center; background:#ccc; font-weight:bold; padding:5px; margin-top:20pt;">${r.subject}</div>`;
            if(r.see_also) content += `<div style="text-align:center; background:#eee; padding:3px;">أنظر أيضاً: ${r.see_also}</div>`;
            lastSubject = r.subject;
        }
        if(!r.see && !r.see_also) {
            let entry = formatEntry(r);
            content += `<div style="margin-bottom:15pt;">
                ${r.author ? `<div style="font-weight:bold;">${r.author} <span style="float:left">(${serial})</span></div>` : ""}
                <div style="text-align:justify;">${r.author ? entry.replace(`<span style="font-weight:bold">${r.author}</span>`, "").replace(/^\. /, "") : entry + ` <span style="float:left">(${serial})</span>`}</div>
                <div style="clear:both"></div>
            </div>`;
            serial++;
        }
    });
    content += `</div>`; win.document.write(content);
}

function previewIndex(type) {
    let win = window.open('', '', 'width=900,height=700');
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; column-count:2; font-size:11pt;">`;
    let map = {}; let serial = 1;
    records.forEach(r => { if(!r.see && !r.see_also) { (r[type]||"").split('؛').forEach(v => { v=v.trim(); if(v){ if(!map[v]) map[v]=[]; map[v].push(serial); }}); serial++; }});
    Object.keys(map).sort((a,b)=>cleanForSort(a).localeCompare(cleanForSort(b),'ar')).forEach(k => {
        content += `<div style="border-bottom:0.5pt solid #eee; margin-bottom:4pt;">${k} <span style="float:left; font-weight:bold;">(${map[k].join(')( ')})</span><div style="clear:both"></div></div>`;
    });
    content += `</div>`; win.document.write(content);
}

function exportToExcel() {
    const ws = XLSX.utils.json_to_sheet(records);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, `${currentProj}.xlsx`);
}

function importFromExcel(e) {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        records = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        sortData(); updateUI();
    };
    reader.readAsBinaryString(e.target.files[0]);
}

function editRec(i) { editIdx = i; Object.keys(records[i]).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = records[i][k]; }); }
function createNewProject() { let name = prompt("اسم المشروع:"); if(name) { currentProj = name; localStorage.setItem('lib_active_proj', name); location.reload(); } }

window.onload = () => { 
    document.getElementById('activeProjectLabel').innerText = currentProj;
    updateUI(); 
};
</script>
</body>
</html>
