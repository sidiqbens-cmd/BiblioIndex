<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #343a40; color: #f8f9fa; margin: 0; padding: 5px; font-size: 11px; }
        .project-bar { background: #212529; color: #fff; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #495057; margin-bottom: 5px; }
        .dropdown { position: relative; display: inline-block; }
        .dropbtn { background: #495057; color: white; padding: 5px 15px; font-size: 11px; border: 1px solid #6c757d; cursor: pointer; border-radius: 4px; }
        .dropdown-content { display: none; position: absolute; background-color: #f8f9fa; min-width: 180px; box-shadow: 0px 8px 16px rgba(0,0,0,0.3); z-index: 1000; right: 0; border: 1px solid #dee2e6; }
        .dropdown-content button { color: #212529; padding: 10px; display: block; width: 100%; border: none; text-align: right; background: none; cursor: pointer; border-bottom: 1px solid #e9ecef; }
        .dropdown-content button:hover { background-color: #e9ecef; }
        .dropdown:hover .dropdown-content { display: block; }
        .compact-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #dee2e6; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 10px; color: #495057; font-weight: bold; margin-bottom: 2px; text-align: center; }
        input, select { border: 1px solid #adb5bd; background: #ffffff; color: #212529; padding: 4px; font-size: 12px; height: 24px; text-align: right; border-radius: 2px; }
        .warning-field { border: 2px solid #dc3545 !important; background: #fff3f3 !important; }
        .actions { margin: 10px 0; display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
        .btn { padding: 6px 14px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-weight: bold; font-size: 11px; }
        .btn-save { background: #28a745; } .btn-excel { background: #17a2b8; } .btn-word { background: #007bff; } .btn-danger { background: #dc3545; }
        .preview-table { width: 100%; border-collapse: collapse; background: #ffffff; margin-top: 10px; border: 1px solid #dee2e6; }
        .preview-table th { background: #e9ecef; color: #495057; padding: 8px; border: 1px solid #dee2e6; }
        .preview-table td { border: 1px solid #dee2e6; padding: 6px; text-align: right; color: #212529; }
        tr:nth-child(even) { background: #f8f9fa; }
        #smartModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#2d3238; border:2px solid #007bff; padding:15px; z-index:2000; width:450px; box-shadow: 0 0 30px rgba(0,0,0,0.7); color:white; }
    </style>
</head>
<body>

<div class="project-bar">
    <div><strong>الفهرس الليبي الموحد</strong> | المشروع: <span id="activeProjectLabel" style="color:#ffc107"></span></div>
    <div style="display:flex; gap:10px; align-items: center;">
        <button onclick="document.getElementById('smartModal').style.display='block'" class="btn" style="background:#6f42c1">⚡ إدخال ذكي</button>
        <button onclick="createNewProject()" class="btn btn-save">+ مشروع جديد</button>
        <div class="dropdown">
            <button class="dropbtn">المشاريع ▼</button>
            <div id="projectDropdown" class="dropdown-content"></div>
        </div>
    </div>
</div>

<div id="smartModal">
    <h3 style="margin:0 0 10px 0;">توزيع النص ذكياً</h3>
    <textarea id="smartInput" rows="5" style="width:100%; background:#1a1d21; color:white; border:1px solid #444;" placeholder="أدخل النص هنا..."></textarea>
    <div style="margin-top:10px; display:flex; gap:5px;">
        <button class="btn btn-save" onclick="processSmartPaste()">توزيع</button>
        <button class="btn btn-danger" onclick="document.getElementById('smartModal').style.display='none'">إلغاء</button>
    </div>
</div>

<form id="biblioForm">
    <div class="compact-grid">
        <div class="field-group"><label>رأس الموضوع</label><input type="text" id="subject" class="in"></div>
        <div class="field-group"><label>إحالة انظر</label><input type="text" id="see" class="in" onblur="validateSubjectRef(this)"></div>
        <div class="field-group"><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in" onblur="validateSubjectRef(this)"></div>
        <div class="field-group"><label>المؤلف (اللقب، الاسم)</label><input type="text" id="author" class="in"></div>
        <div class="field-group"><label>العنوان</label><input type="text" id="title" class="in"></div>
        <div class="field-group"><label>المشاركون/المترجمون</label><input type="text" id="collab" class="in"></div>
    </div>
    <div class="compact-grid" style="margin-top:4px;">
        <div class="field-group"><label>الطبعة</label><input type="text" id="edition" class="in"></div>
        <div class="field-group"><label>مكان النشر</label><input type="text" id="place" class="in"></div>
        <div class="field-group"><label>الناشر</label><input type="text" id="publisher" class="in"></div>
        <div class="field-group"><label>السنة</label><input type="text" id="year" class="in"></div>
        <div class="field-group"><label>صفحات</label><input type="text" id="pages" class="in"></div>
        <div class="field-group"><label>السلسلة</label><input type="text" id="series" class="in"></div>
    </div>
    <div class="compact-grid" style="margin-top:4px; grid-template-columns: repeat(7, 1fr);">
        <div class="field-group"><label>عنوان أصلي</label><input type="text" id="orig_title" class="in"></div>
        <div class="field-group"><label>مؤلف أصلي</label><input type="text" id="orig_author" class="in"></div>
        <div class="field-group"><label>جهة الإصدار</label><input type="text" id="org" class="in"></div>
        <div class="field-group"><label>عدد المؤلفين</label><input type="number" id="count" class="in"></div>
        <div class="field-group"><label>التبعية المؤسسية</label><input type="text" id="affil" class="in"></div>
        <div class="field-group"><label>الدولة</label><input type="text" id="country" class="in"></div>
        <div class="field-group">
            <label>النوع</label>
            <select id="type" class="in"><option value="كتاب">كتاب</option><option value="مقالة">مقالة</option><option value="فصل">فصل</option></select>
        </div>
    </div>
</form>

<div class="actions">
    <button class="btn btn-save" onclick="saveData()">حفظ (Enter)</button>
    <button class="btn btn-excel" onclick="exportToExcel()">تصدير Excel</button>
    <button class="btn btn-excel" style="background:#6f42c1" onclick="document.getElementById('importFile').click()">استيراد Excel</button>
    <input type="file" id="importFile" style="display:none" onchange="importFromExcel(event)">
    <button class="btn btn-word" onclick="previewFullList()">معاينة القائمة</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('author')">كشاف المؤلفين</button>
    <button class="btn btn-word" style="background:#d43f3a" onclick="previewIndex('collab')">كشاف المترجمين</button>
</div>

<table class="preview-table">
    <thead><tr><th>ت</th><th>رأس الموضوع</th><th>البيان الببليوغرافي</th><th>الإجراء</th></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
let projects = JSON.parse(localStorage.getItem('lib_proj_list')) || ['تجربة 1'];
let currentProj = localStorage.getItem('lib_active_proj') || 'تجربة 1';
let records = JSON.parse(localStorage.getItem('recs_' + currentProj)) || [];
let editIdx = -1;

function cleanForSort(str) {
    if (!str) return "";
    return str.trim().replace(/^ال(?=[^ل])/, "").replace(/[أإآ]/g, "ا").replace(/[ى]/g, "ي");
}

function validateSubjectRef(input) {
    let val = input.value.trim();
    if(!val) { input.classList.remove('warning-field'); return; }
    let exists = records.some(r => r.subject === val);
    if(!exists) { alert(`الرأس "${val}" غير موجود!`); input.classList.add('warning-field'); }
    else { input.classList.remove('warning-field'); }
}

function saveData() {
    let data = {}; document.querySelectorAll('.in').forEach(f => data[f.id] = f.value.trim());
    if(!data.subject) return alert("الرأس مطلوب");
    
    // قلب الاسم آلياً (اللقب، الاسم)
    if(data.author && !data.author.includes('،')) {
        let parts = data.author.split(' ');
        if(parts.length > 1) {
            let last = parts.pop();
            data.author = `${last}، ${parts.join(' ')}`;
        }
    }

    if(editIdx > -1) records[editIdx] = data; else records.push(data);
    editIdx = -1; sortData(); updateUI(); document.getElementById('biblioForm').reset();
}

function sortData() { records.sort((a,b) => cleanForSort(a.subject).localeCompare(cleanForSort(b.subject), 'ar')); }

function formatEntry(r) {
    if(r.see || r.see_also) return ""; // الإحالات لا تظهر كبيان كتاب
    let p = [];
    if(r.author) p.push(`<span style="font-weight:bold">${r.author}</span>`);
    if(r.title) p.push(`. <span style="${!r.author?'font-weight:bold':''}">${r.title}</span>`);
    if(r.collab) p.push(`؛ ${r.collab}`);
    if(r.year) p.push(`، ${r.year}`);
    return p.join('').replace(/^\. /, "");
}

function updateUI() {
    localStorage.setItem('recs_'+currentProj, JSON.stringify(records));
    let h = ''; let s = 1;
    records.forEach((r,i) => { 
        let entry = formatEntry(r);
        h += `<tr>
            <td>${r.see||r.see_also?'--':s++}</td>
            <td style="color:#0056b3; cursor:pointer;" onclick="editRec(${i})">${r.subject} ${r.see? '(انظر: '+r.see+')' : ''}</td>
            <td>${entry}</td>
            <td>
                <button onclick="editRec(${i})">تعديل</button>
                <button class="btn-danger" onclick="deleteRec(${i})" style="padding:2px 5px; font-size:9px;">حذف</button>
            </td>
        </tr>`; 
    });
    document.getElementById('tableBody').innerHTML = h;
    renderProjectDropdown();
}

function deleteRec(i) { if(confirm("حذف السجل؟")) { records.splice(i, 1); updateUI(); } }

function renderProjectDropdown() {
    document.getElementById('activeProjectLabel').innerText = currentProj;
    document.getElementById('projectDropdown').innerHTML = projects.map(p => 
        `<button onclick="switchProject('${p}')">${p === currentProj ? '✓ ' : ''}${p}</button>`
    ).join('');
}

function switchProject(name) { localStorage.setItem('lib_active_proj', name); location.reload(); }
function createNewProject() {
    let name = prompt("اسم المشروع الجديد:");
    if(name && !projects.includes(name)) { projects.push(name); localStorage.setItem('lib_proj_list', JSON.stringify(projects)); switchProject(name); }
}

function processSmartPaste() {
    let t = document.getElementById('smartInput').value;
    let parts = t.split('.');
    if(parts[0]) document.getElementById('author').value = parts[0].trim();
    if(parts[1]) document.getElementById('title').value = parts[1].trim();
    document.getElementById('smartModal').style.display='none';
}

function exportToExcel() {
    const ws = XLSX.utils.json_to_sheet(records);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Records");
    XLSX.writeFile(wb, `${currentProj}.xlsx`);
}

function importFromExcel(e) {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        records = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        sortData(); updateUI();
    };
    reader.readAsBinaryString(e.target.files[0]);
}

function previewFullList() {
    let win = window.open('', '', 'width=900,height=700');
    let serial = 1; let lastSubject = "";
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; font-size:12pt;">`;
    records.forEach(r => {
        if(r.subject !== lastSubject) {
            content += `<div style="text-align:center; background:#e9ecef; font-weight:bold; padding:5px; margin-top:20pt;">${r.subject}</div>`;
            if(r.see) content += `<div style="text-align:center;">انظر: ${r.see}</div>`;
            if(r.see_also) content += `<div style="text-align:center;">انظر أيضاً: ${r.see_also}</div>`;
            lastSubject = r.subject;
        }
        let entry = formatEntry(r);
        if(entry) {
            content += `<div style="margin-bottom:10pt;">${entry} <span style="float:left">(${serial++})</span></div><div style="clear:both"></div>`;
        }
    });
    content += `</div>`; win.document.write(content);
}

function previewIndex(type) {
    let win = window.open('', '', 'width=900,height=700');
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; column-count:2; font-size:11pt;">`;
    let map = {}; let serial = 1;
    records.forEach(r => { 
        let entry = formatEntry(r);
        if(entry) {
            (r[type]||"").split('؛').forEach(v => { v=v.trim(); if(v){ if(!map[v]) map[v]=[]; map[v].push(serial); }});
            serial++;
        }
    });
    Object.keys(map).sort((a,b)=>cleanForSort(a).localeCompare(cleanForSort(b),'ar')).forEach(k => {
        content += `<div>${k} <b>(${map[k].join(')( ')})</b></div>`;
    });
    content += `</div>`; win.document.write(content);
}

function editRec(i) { editIdx = i; Object.keys(records[i]).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = records[i][k]; }); }
window.onload = updateUI;
</script>
</body>
</html>
