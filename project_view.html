<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #eceef1; margin: 0; padding: 0; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; border-bottom: 2px solid #000; }
        .input-table { width: 100%; background: #cfcfcf; border-spacing: 2px; padding: 2px; table-layout: fixed; }
        label { font-size: 9px; font-weight: bold; color: #333; display: block; text-align: center; }
        input { width: 100%; height: 18px; font-size: 10px; border: 1px solid #999; text-align: right; background: #fff; }
        .actions { background: #cfcfcf; text-align: center; padding: 4px; display: flex; justify-content: center; gap: 4px; border-bottom: 2px solid #2c3e50; }
        .btn { padding: 3px 8px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 10px; font-weight: bold; }
        
        .scroll-area { margin-top: 175px; height: calc(100vh - 180px); overflow: auto; }
        .admin-table { border-collapse: collapse; background: #fff; font-size: 10px; min-width: 2500px; }
        .admin-table th { position: sticky; top: 0; background: #34495e; color: white; z-index: 100; padding: 5px; }
        .admin-table td { border: 1px solid #ccc; padding: 3px; text-align: right; }
        
        /* ØªØ¬Ù…ÙŠØ¯ Ø£ÙˆÙ„ 3 Ø£Ø¹Ù…Ø¯Ø© */
        .admin-table th:nth-child(1), .admin-table td:nth-child(1) { position: sticky; right: 0; background: #f0f0f0; z-index: 21; width: 40px; }
        .admin-table th:nth-child(2), .admin-table td:nth-child(2) { position: sticky; right: 40px; background: #f0f0f0; z-index: 21; width: 60px; }
        .admin-table th:nth-child(3), .admin-table td:nth-child(3) { position: sticky; right: 100px; background: #fff; z-index: 21; width: 150px; border-left: 2px solid #2c3e50; }

        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; }
        .modal-content { background:white; width:85%; margin:1% auto; padding:30px; height: 90vh; overflow-y: auto; }
        .preview-subject { background: #d1d1d1; text-align: center; font-weight: bold; padding: 5px; margin: 15px 0 5px 0; font-size: 16px; border: 1px solid #999; }
        .preview-see-line { background: #f9f9f9; text-align: center; font-size: 14px; padding: 3px; margin-bottom: 10px; border: 1px solid #ddd; }
        .entry-container { margin-bottom: 15px; line-height: 1.4; font-size: 15px; }
        .first-line { display: flex; justify-content: space-between; align-items: baseline; }
        .bold-text { font-weight: bold; }
        
        .idx-list { columns: 2; list-style: none; padding: 0; font-size: 12px; }
        .editor-style { font-style: italic; color: #555; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:4px 15px;">
        <strong style="font-size:12px;">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</strong>
        <div style="display:flex; gap:6px;">
            <button onclick="document.getElementById('xlIn').click()" class="btn" style="background:#e67e22">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <button onclick="exportX()" class="btn" style="background:#2980b9">ğŸ’¾ ØªØµØ¯ÙŠØ± Excel</button>
            <input type="file" id="xlIn" style="display:none" onchange="importX(event)">
            <button onclick="newP()" class="btn" style="background:#27ae60">+ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
            <select id="pSel" onchange="switchP(this.value)" style="font-size:10px; height:18px;"></select>
            <button onclick="delP()" class="btn" style="background:#c0392b">Ø­Ø°Ù</button>
        </div>
    </div>

    <form id="bForm">
        <table class="input-table">
            <tr>
                <td><label>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label><input type="text" id="subject" class="in"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø±</label><input type="text" id="see" class="in"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹</label><input type="text" id="see_also" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù…Ù‚Ù„ÙˆØ¨)</label><input type="text" id="author" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="author_preview" class="in"></td>
                <td><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="title" class="in"></td>
            </tr>
            <tr>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="collab" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="collab_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="translator" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="trans_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¬Ù„Ø©</label><input type="text" id="journal" class="in"></td>
                <td><label>Ø§Ù„Ù†Ø§Ø´Ø±</label><input type="text" id="publisher" class="in"></td>
            </tr>
            <tr>
                <td><label>Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø´Ø±</label><input type="text" id="place" class="in"></td>
                <td><label>Ø§Ù„ØªØ¨Ø¹ÙŠØ©/Ø§Ù„Ø¬Ù‡Ø©</label><input type="text" id="affiliation" class="in"></td>
                <td><label>Ù…Ø­Ù‚Ù‚/Ù…Ø±Ø§Ø¬Ø¹Ø©</label><input type="text" id="editor" class="in"></td>
                <td><label>Ø¹Ù†ÙˆØ§Ù† Ø£ØµÙ„ÙŠ</label><input type="text" id="orig_title" class="in"></td>
                <td><label>Ø§Ù„Ø³Ù†Ø©</label><input type="text" id="year" class="in"></td>
                <td><label>ØµÙØ­Ø§Øª</label><input type="text" id="pages" class="in"></td>
            </tr>
        </table>
        <div class="actions">
            <button type="button" class="btn" style="background:#27ae60" onclick="save()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="showBiblio()">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="idx('author', 'Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†</button>
            <button type="button" class="btn" style="background:#d35400" onclick="idx('title', 'Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="idx('trans_idx', 'Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†</button>
            <button type="button" class="btn" style="background:#16a085" onclick="idx('journal', 'Ø§Ù„Ù…Ø¬Ù„Ø§Øª')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="idx('subject', 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª')">Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª</button>
        function openSmartInput() {
    let html = `
        <h3>Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <p style="font-size:11px; color:red;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨Ù€ (Ø›) Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø› Ø§Ù„Ù…Ø¤Ù„Ù Ù…Ù‚Ù„ÙˆØ¨ Ø› Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø› Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø› Ø§Ù„Ù†Ø§Ø´Ø± Ø› Ø§Ù„Ø³Ù†Ø©</p>
        <textarea id="smartArea" style="width:100%; height:150px; text-align:right;" placeholder="Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø› Ø§Ù„Ù…Ø¤Ù„Ù Ù…Ù‚Ù„ÙˆØ¨ Ø› Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø› Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ..."></textarea>
        <br><br>
        <button class="btn" style="background:#27ae60" onclick="processSmart()">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    `;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalOverlay').style.display = 'block';
}

function processSmart() {
    let raw = document.getElementById('smartArea').value;
    let parts = raw.split('Ø›').map(p => p.trim());
    
    // Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø§Øª
    if(parts[0]) document.getElementById('subject').value = parts[0];
    if(parts[1]) document.getElementById('author').value = parts[1];
    if(parts[2]) document.getElementById('author_preview').value = parts[2];
    if(parts[3]) document.getElementById('title').value = parts[3];
    if(parts[4]) document.getElementById('publisher').value = parts[4];
    if(parts[5]) document.getElementById('year').value = parts[5];
    
    closeM();
    alert("ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©.");
}

// ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
function save() {
    let d = {}; 
    document.querySelectorAll('.in').forEach(i => d[i.id] = i.value.trim());
    
    if(!d.subject) return alert("Ø§Ù„Ø±Ø£Ø³ Ù…Ø·Ù„ÙˆØ¨");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
    if(d.see || d.see_also) {
        let target = d.see || d.see_also;
        let exists = recs.some(r => r.subject === target);
        if(!exists) {
            if(!confirm(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø­Ø§Ù„ Ø¥Ù„ÙŠÙ‡ "${target}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ`)) {
                return;
            }
        }
    }

    recs.push(d); 
    draw(); 
    document.getElementById('bForm').reset(); 
    document.getElementById('subject').focus();
}
        </div>
    </form>
</div>

<div id="modalOverlay"><div class="modal-content"><button onclick="closeM()" style="float:left; background:#c0392b; color:white; border:none; padding:5px 15px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button><div id="modalBody"></div></div></div>

<div class="scroll-area">
    <table class="admin-table">
        <thead id="adminHead"></thead>
        <tbody id="adminBody"></tbody>
    </table>
</div>

<script>
let projs = JSON.parse(localStorage.getItem('L_P')) || ['Ù…Ø´Ø±ÙˆØ¹_1'];
let curP = localStorage.getItem('L_A') || 'Ù…Ø´Ø±ÙˆØ¹_1';
let recs = JSON.parse(localStorage.getItem('R_' + curP)) || [];
const cleanAL = (s) => s ? s.replace(/^(Ø§Ù„)/, '').trim() : '';
const flds = ['subject', 'see', 'see_also', 'author', 'author_preview', 'title', 'collab', 'collab_idx', 'translator', 'trans_idx', 'journal', 'publisher', 'place', 'affiliation', 'editor', 'orig_title', 'year', 'pages'];

function draw() {
    recs.sort((a, b) => cleanAL(a.subject).localeCompare(cleanAL(b.subject), 'ar'));
    localStorage.setItem('R_' + curP, JSON.stringify(recs));
    localStorage.setItem('L_P', JSON.stringify(projs));
    localStorage.setItem('L_A', curP);

    let hHead = '<tr><th>Ø±Ù‚Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>' + flds.slice(1).map(f => `<th>${f}</th>`).join('') + '</tr>';
    document.getElementById('adminHead').innerHTML = hHead;

    let hBody = '', entryCounter = 1;
    recs.forEach((r, i) => {
        let isRef = (r.see || r.see_also) && !r.title;
        let displayNum = isRef ? '-' : entryCounter++;
        r.finalID = isRef ? null : displayNum;
        hBody += `<tr><td>${displayNum}</td><td><button onclick="edit(${i})">ØªØ¹Ø¯ÙŠÙ„</button></td>` + flds.map(f => `<td>${r[f] || ''}</td>`).join('') + `</tr>`;
    });
    document.getElementById('adminBody').innerHTML = hBody;
    document.getElementById('pSel').innerHTML = projs.map(p=>`<option ${p===curP?'selected':''}>${p}</option>`).join('');
}

function showBiblio() {
    let h = '<h2 style="text-align:center">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø¨Ù„ÙŠÙˆØºØ±Ø§ÙÙŠØ©</h2>', lastSub = '';
    recs.forEach((r) => {
        if (r.subject !== lastSub) {
            h += `<div class="preview-subject">${r.subject}</div>`;
            let refs = [];
            if (r.see_also) refs.push(`Ø§Ù†Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹: ${r.see_also}`);
            if (r.see && !r.title) refs.push(`Ø§Ù†Ø¸Ø±: ${r.see}`);
            if (refs.length > 0) h += `<div class="preview-see-line">${refs.join(' . - ')}</div>`;
            lastSub = r.subject;
        }
        if (r.title) {
            let responsibility = '';
            if(r.author_preview) responsibility += r.author_preview;
            if(r.collab) responsibility += (responsibility ? 'ØŒ ' : '') + r.collab;
            if(r.translator) responsibility += (responsibility ? 'Ø› ' : '') + 'ØªØ±Ø¬Ù…Ø© ' + r.translator;
            if(r.editor) responsibility += (responsibility ? 'Ø› ' : '') + r.editor;

            let pgStr = r.pages ? (r.journal ? 'Øµ ' + r.pages : r.pages + ' Øµ') : '';

            h += `<div class="entry-container">
                <div class="first-line">
                    <span class="bold-text">${r.author || ''}</span>
                    <span class="entry-num">(${r.finalID})</span>
                </div>
                <div>
                    <span class="${!r.author ? 'bold-text' : ''}">${r.title}</span> 
                    ${responsibility ? ' / ' + responsibility : ''}. - 
                    ${r.place ? r.place + ': ' : ''} ${r.publisher ? r.publisher + ', ' : ''}
                    ${r.year ? r.year + '. - ' : ''} ${pgStr}
                </div>
            </div>`;
        }
    });
    document.getElementById('modalBody').innerHTML = h;
    document.getElementById('modalOverlay').style.display = 'block';
}

function idx(field, title) {
    let map = {};
    recs.forEach(r => {
        let rawVal = (field === 'journal') ? (r.journal ? r.journal + (r.affiliation ? ' - ' + r.affiliation : '') : null) : r[field];
        if (rawVal && r.finalID) {
            // Ø§Ù„ÙØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø§Ø±Ø·Ø© Ø§Ù„Ù…Ø§Ø¦Ù„Ø© / Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø©
            let parts = rawVal.split('/').map(p => p.trim()).filter(p => p !== "");
            parts.forEach(p => {
                if (!map[p]) map[p] = [];
                let isEditor = (r.author_preview && r.author_preview.includes("ØªØ­Ø±ÙŠØ±")) || (r.collab && r.collab.includes("ØªØ­Ø±ÙŠØ±"));
                map[p].push({ num: r.finalID, editor: isEditor });
            });
        }
    });
    let keys = Object.keys(map).sort((a,b) => cleanAL(a).localeCompare(cleanAL(b), 'ar'));
    let h = `<h3 style="text-align:center">ÙƒØ´Ø§Ù ${title}</h3><ul class="idx-list">`;
    keys.forEach(k => {
        let nums = map[k].map(n => n.editor ? `<span class="editor-style">Ù…Ø­Ø±Ø± (${n.num})</span>` : `(${n.num})`).join(' ');
        h += `<li>${k} ${nums}</li>`;
    });
    document.getElementById('modalBody').innerHTML = h + '</ul>';
    document.getElementById('modalOverlay').style.display = 'block';
}

function save() {
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value.trim());
    if(!d.subject) return alert("Ø§Ù„Ø±Ø£Ø³ Ù…Ø·Ù„ÙˆØ¨");
    recs.push(d); draw(); document.getElementById('bForm').reset(); document.getElementById('subject').focus();
}

function exportX() {
    const ws = XLSX.utils.json_to_sheet(recs);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, `Fahras_${curP}.xlsx`);
}

function importX(e) {
    const reader = new FileReader();
    reader.onload = (evt) => {
        recs = [...recs, ...XLSX.utils.sheet_to_json(XLSX.read(evt.target.result, {type:'binary'}).Sheets[XLSX.read(evt.target.result, {type:'binary'}).SheetNames[0]])];
        draw();
    };
    reader.readAsBinaryString(e.target.files[0]);
}

function edit(i) {
    let r = recs[i];
    flds.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = r[f] || ''; });
    recs.splice(i, 1); draw(); window.scrollTo(0,0);
}

function closeM() { document.getElementById('modalOverlay').style.display='none'; }
function newP() { let n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:"); if(n) { projs.push(n); curP = n; recs = []; draw(); } }
function switchP(v) { curP = v; recs = JSON.parse(localStorage.getItem('R_' + v)) || []; draw(); }
function delP() { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ")) { localStorage.removeItem('R_'+curP); projs = projs.filter(p=>p!==curP); curP=projs[0]||'Ù…Ø´Ø±ÙˆØ¹_1'; draw(); } }
window.onload = draw;
</script>
</body>
</html>
