<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد - المحرر المتكامل</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 5px; font-size: 11px; }
        .project-bar { background: #24292e; color: #fff; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .compact-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; background: #fff; padding: 5px; border: 1px solid #ccc; }
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 9px; color: #555; font-weight: bold; margin-bottom: 1px; }
        input { border: 1px solid #bbb; padding: 2px; font-size: 12px; height: 20px; }
        input:focus { border-color: #007bff; background: #fffde7; outline: none; }
        .w-small { grid-column: span 1; }
        .w-med { grid-column: span 2; }
        .actions { margin: 5px 0; display: flex; gap: 4px; flex-wrap: wrap; }
        .btn { padding: 4px 10px; cursor: pointer; border: none; border-radius: 2px; color: #fff; font-weight: bold; font-size: 10px; }
        .btn-save { background: #28a745; }
        .btn-excel { background: #17a2b8; }
        .btn-word { background: #007bff; }
        .preview-table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 5px; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 3px; text-align: right; }
        .is-reference { background: #fdfdfd; color: #777; font-style: italic; }
    </style>
</head>
<body>

<div class="project-bar">
    <div>
        <strong>الفهرس الليبي الموحد</strong> | المشروع: <span id="activeProject" style="color:#ffc107"></span>
        <select id="projectSelector" onchange="loadProject(this.value)" style="margin-right:10px; font-size:10px;"></select>
    </div>
    <button onclick="createNewProject()" style="font-size: 9px; padding: 2px 8px;">+ مشروع جديد</button>
</div>

<form id="biblioForm" class="compact-grid">
    <div class="field-group w-med"><label>رأس الموضوع</label><input type="text" id="subject" class="in"></div>
    <div class="field-group w-med"><label>إحالة انظر</label><input type="text" id="see" class="in"></div>
    <div class="field-group w-med"><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in"></div>
    <div class="field-group w-med"><label>المؤلف</label><input type="text" id="author" class="in"></div>
    <div class="field-group w-med"><label>العنوان</label><input type="text" id="title" class="in"></div>
    
    <div class="field-group w-med"><label>المشاركون (؛)</label><input type="text" id="collab" class="in"></div>
    <div class="field-group w-small"><label>الطبعة</label><input type="text" id="edition" class="in"></div>
    <div class="field-group w-med"><label>مكان النشر</label><input type="text" id="place" class="in"></div>
    <div class="field-group w-med"><label>الناشر</label><input type="text" id="publisher" class="in"></div>
    <div class="field-group w-small"><label>السنة</label><input type="text" id="year" class="in"></div>
    <div class="field-group w-small"><label>صفحات</label><input type="text" id="pages" class="in"></div>
    <div class="field-group w-med"><label>السلسلة</label><input type="text" id="series" class="in"></div>
    <div class="field-group w-med"><label>عنوان أصلي</label><input type="text" id="orig_title" class="in"></div>
    <div class="field-group w-med"><label>مؤلف أصلي</label><input type="text" id="orig_author" class="in"></div>
    <div class="field-group w-med"><label>جهة الإصدار</label><input type="text" id="org" class="in"></div>
    <div class="field-group w-small"><label>عدد المؤلفين</label><input type="number" id="count" class="in"></div>
    <div class="field-group w-small"><label>التبعية</label><input type="text" id="affil" class="in"></div>
    <div class="field-group w-small"><label>الدولة</label><input type="text" id="country" class="in"></div>
</form>

<div class="actions">
    <button class="btn btn-save" onclick="saveData()">حفظ (Enter)</button>
    <button class="btn btn-excel" onclick="exportTemplate()">تصدير قالب Excel</button>
    <button class="btn btn-excel" style="background:#6f42c1" onclick="document.getElementById('importFile').click()">استيراد Excel</button>
    <input type="file" id="importFile" style="display:none" onchange="importFromExcel(event)">
    <button class="btn btn-word" onclick="previewFullList()">معاينة القائمة (Word)</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('author')">كشاف المؤلفين</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('title')">كشاف العناوين</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('orig_author')">كشاف المؤلف الأصلي</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('orig_title')">كشاف العنوان الأصلي</button>
</div>

<table class="preview-table">
    <thead>
        <tr><th>ت</th><th>رأس الموضوع</th><th>البيان الببليوغرافي</th><th>إجراءات</th></tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
let projects = JSON.parse(localStorage.getItem('all_project_names')) || ['default'];
let currentProj = localStorage.getItem('biblio_active_proj') || 'default';
let records = JSON.parse(localStorage.getItem('records_' + currentProj)) || [];
let editIdx = -1;

function updateProjectList() {
    const sel = document.getElementById('projectSelector');
    sel.innerHTML = projects.map(p => `<option value="${p}" ${p === currentProj ? 'selected' : ''}>${p}</option>`).join('');
    document.getElementById('activeProject').innerText = currentProj;
}

function createNewProject() {
    let p = prompt("اسم المشروع الجديد:");
    if(p && !projects.includes(p)) {
        projects.push(p);
        localStorage.setItem('all_project_names', JSON.stringify(projects));
        loadProject(p);
    }
}

function loadProject(p) {
    localStorage.setItem('biblio_active_proj', p);
    location.reload();
}

function saveData() {
    let fields = document.querySelectorAll('.in');
    let data = {};
    fields.forEach(f => data[f.id] = f.value);
    if(!data.subject) return alert("الرأس مطلوب");
    if(editIdx > -1) { records[editIdx] = data; editIdx = -1; }
    else { records.push(data); }
    sortData(); updateUI();
    document.getElementById('biblioForm').reset();
    fields[0].focus();
}

function sortData() {
    records.sort((a, b) => {
        const clean = (s) => (s || "").replace(/^ال/, "").trim();
        return clean(a.subject).localeCompare(clean(b.subject), 'ar');
    });
}

function updateUI() {
    localStorage.setItem('records_' + currentProj, JSON.stringify(records));
    let html = ''; let serial = 1;
    records.forEach((r, i) => {
        let isRef = (r.see || r.see_also);
        html += `<tr class="${isRef ? 'is-reference' : ''}">
            <td>${isRef ? '--' : serial++}</td>
            <td style="font-weight:bold; color:blue">${r.subject}</td>
            <td>${formatEntry(r)}</td>
            <td>
                <button onclick="editRecord(${i})">تعديل</button>
                <button onclick="deleteRecord(${i})">حذف</button>
            </td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = html;
}

function formatEntry(r) {
    if(r.see) return `انظر: ${r.see}`;
    if(r.see_also) return `انظر أيضاً: ${r.see_also}`;
    let base = `${r.author}. ${r.title}؛ ${r.collab}. - ط ${r.edition}. - ${r.place}: ${r.publisher}، ${r.year}. - ص ص ${r.pages}.`;
    if(r.orig_title) base += ` - العنوان الأصلي: ${r.orig_title}.`;
    return base + ` - (${r.country})`;
}

function editRecord(i) {
    editIdx = i; let r = records[i];
    document.querySelectorAll('.in').forEach(f => f.value = r[f.id] || '');
    window.scrollTo(0,0);
}

function deleteRecord(i) {
    if(confirm("حذف؟")) { records.splice(i, 1); updateUI(); }
}

function exportTemplate() {
    const template = [["subject","see","see_also","author","title","collab","edition","place","publisher","year","pages","series","orig_title","orig_author","org","count","affil","country"]];
    const ws = XLSX.utils.aoa_to_sheet(template);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "قالب_الفهرس.xlsx");
}

function importFromExcel(e) {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        records = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        sortData(); updateUI();
    };
    reader.readAsBinaryString(e.target.files[0]);
}

function previewFullList() {
    let win = window.open('', '', 'width=850,height=700');
    let serial = 1;
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; line-height:1.5; font-size:12pt;">`;
    records.forEach(r => {
        let isRef = (r.see || r.see_also);
        let num = isRef ? '' : `<span style="float:left;">(${serial++})</span>`;
        content += `<div style="margin-bottom:15pt; text-align:justify;">
            <strong>${r.subject}</strong><br>${formatEntry(r)} ${num}
            <div style="clear:both"></div>
        </div>`;
    });
    content += `</div>`; win.document.write(content);
}

function previewIndex(type) {
    let win = window.open('', '', 'width=850,height=700');
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; line-height:1.3; font-size:12pt; column-count: 2; column-gap: 0.5in;">`;
    let indexMap = {}; let serial = 1;
    records.forEach(r => {
        if(!(r.see || r.see_also)) {
            let key = r[type];
            if(key) {
                if(!indexMap[key]) indexMap[key] = [];
                indexMap[key].push(serial);
            }
            serial++;
        }
    });
    Object.keys(indexMap).sort((a,b)=>a.localeCompare(b,'ar')).forEach(key => {
        content += `<div style="margin-bottom:8pt; text-align:justify; border-bottom:0.5pt solid #eee;">
            ${key} <span style="float:left; font-weight:bold;">(${indexMap[key].join(')( ')})</span>
            <div style="clear:both"></div>
        </div>`;
    });
    content += `</div>`; win.document.write(content);
}

document.querySelectorAll('.in').forEach((input, index, list) => {
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (index < list.length - 1) list[index+1].focus();
            else saveData();
        }
    });
});
window.onload = updateProjectList(); updateUI();
</script>
</body>
</html>
