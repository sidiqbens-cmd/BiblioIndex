<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #eceef1; margin: 0; padding: 0; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; border-bottom: 2px solid #000; }
        .input-table { width: 100%; background: #cfcfcf; border-spacing: 2px; padding: 5px; table-layout: fixed; }
        .field-label { font-size: 11px; font-weight: bold; color: #333; display: block; margin-bottom: 2px; }
        input, select { width: 100%; height: 26px; font-size: 13px; font-weight: bold; border: 1px solid #999; text-align: right; box-sizing: border-box; }
        .w-xs { width: 70px !important; }
        .w-sm { width: 100px !important; }
        .actions { background: #cfcfcf; text-align: center; padding: 8px; display: flex; justify-content: center; gap: 6px; border-bottom: 2px solid #2c3e50; flex-wrap: wrap; }
        .btn { padding: 5px 12px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 12px; font-weight: bold; }
        .scroll-area { margin-top: 240px; height: calc(100vh - 250px); overflow-y: auto; padding: 10px; }
        .admin-table { border-collapse: collapse; background: #fff; font-size: 12px; width: 100%; table-layout: fixed; }
        .admin-table th { position: sticky; top: 0; background: #34495e; color: white; padding: 8px; border: 1px solid #2c3e50; }
        .admin-table td { border: 1px solid #ccc; padding: 6px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; }
        .modal-content { background:white; width:90%; margin:1% auto; padding:20px; height: 85vh; overflow-y: auto; }
        .column-wrapper { column-count: 2; column-gap: 30px; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:6px 15px;">
        <strong style="font-size: 18px;">الفهرس الليبي الموحد</strong>
        <div style="display:flex; gap:8px;">
            <button onclick="document.getElementById('xlIn').click()" class="btn" style="background:#e67e22">استيراد XLSX</button>
            <button onclick="exportX()" class="btn" style="background:#2980b9">تصدير XLSX</button>
            <input type="file" id="xlIn" style="display:none" onchange="importX(event)">
            <button onclick="newP()" class="btn" style="background:#27ae60">+ مشروع جديد</button>
            <select id="pSel" style="width:160px" onchange="switchP(this.value)"></select>
            <button onclick="delP()" class="btn" style="background:#c0392b">حذف المشروع</button>
        </div>
    </div>

    <form id="bForm">
        <table class="input-table">
            <tr>
                <td><span class="field-label">رأس الموضوع</span><input type="text" id="subject" list="subjectsList" class="in"></td>
                <td><span class="field-label">إحالة انظر</span><input type="text" id="see" list="subjectsList" class="in"></td>
                <td><span class="field-label">إحالة انظر أيضاً</span><input type="text" id="see_also" list="subjectsList" class="in"></td>
                <td><span class="field-label">مؤلف معاينة</span><input type="text" id="author_preview" class="in"></td>
                <td><span class="field-label">المؤلف الأصلي</span><input type="text" id="original_author" class="in"></td>
                <td><span class="field-label">المؤلف (مقلوب)</span><input type="text" id="author" class="in"></td>
            </tr>
            <tr>
                <td colspan="4"><span class="field-label">العنوان</span><input type="text" id="title" class="in"></td>
                <td><span class="field-label">مشارك معاينة</span><input type="text" id="collab" class="in"></td>
                <td><span class="field-label">مشارك كشاف</span><input type="text" id="collab_idx" class="in"></td>
            </tr>
            <tr>
                <td class="w-xs"><span class="field-label">طبعة</span><input type="text" id="edition" class="in"></td>
                <td><span class="field-label">المجلة</span><input type="text" id="journal" class="in"></td>
                <td class="w-xs"><span class="field-label">العدد</span><input type="text" id="issue" class="in"></td>
                <td><span class="field-label">التبعية</span><input type="text" id="affiliation" class="in"></td>
                <td class="w-sm"><span class="field-label">السنة</span><input type="text" id="year" class="in"></td>
                <td class="w-sm"><span class="field-label">نوع الوعاء</span><input type="text" id="material_type" class="in"></td>
                <td class="w-xs"><span class="field-label">الصفحات</span><input type="text" id="pages" class="in"></td>
            </tr>
            <tr>
                <td><span class="field-label">مكان النشر</span><input type="text" id="place" class="in"></td>
                <td><span class="field-label">الناشر</span><input type="text" id="publisher" class="in"></td>
                <td><span class="field-label">السلسلة</span><input type="text" id="series" class="in"></td>
                <td><span class="field-label">العنوان الأصلي</span><input type="text" id="orig_title" class="in"></td>
                <td><span class="field-label">محقق/مراجعة</span><input type="text" id="editor" class="in"></td>
                <td><span class="field-label">مترجم معاينة</span><input type="text" id="translator" class="in"></td>
                <td><span class="field-label">مترجم كشاف</span><input type="text" id="trans_idx" class="in"></td>
            </tr>
        </table>
        <datalist id="subjectsList"></datalist>
        <div class="actions">
            <button type="button" class="btn" style="background:#27ae60" onclick="save()">حفظ السجل</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="openBiblioWindow()">المعاينة النهائية</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="runAuthorIdx()">كشاف المؤلفين</button>
            <button type="button" class="btn" style="background:#d35400" onclick="runIdx('title', 'العناوين')">كشاف العناوين</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="runIdx('trans_idx', 'المترجمين')">كشاف المترجمين</button>
            <button type="button" class="btn" style="background:#16a085" onclick="journalIdx()">قائمة المجلات</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="runIdx('subject', 'الموضوعات')">رؤوس الموضوعات</button>
        </div>
    </form>
</div>

<div id="modalOverlay">
    <div style="padding: 10px;"><button onclick="closeM()" class="btn" style="background:#c0392b;">إغلاق النافذة</button></div>
    <div class="modal-content" id="modalBody"></div>
</div>

<div class="scroll-area">
    <table class="admin-table">
        <thead>
            <tr>
                <th style="width:50px;">رقم</th>
                <th style="width:200px;">رأس الموضوع</th>
                <th>تفاصيل السجل</th>
                <th style="width:120px;">إجراءات</th>
            </tr>
        </thead>
        <tbody id="adminBody"></tbody>
    </table>
</div>

<script>
let projs = JSON.parse(localStorage.getItem('L_P')) || ['مشروع_1'];
let curP = localStorage.getItem('L_A') || projs[0];
let recs = JSON.parse(localStorage.getItem('R_' + curP)) || [];
let editIndex = -1;
const cleanAL = (s) => s ? s.replace(/^(ال)/, '').trim() : '';

function draw() {
    recs.sort((a, b) => {
        let subA = cleanAL(a.subject);
        let subB = cleanAL(b.subject);
        if (subA !== subB) return subA.localeCompare(subB, 'ar');
        let authA = cleanAL(a.author || '');
        let authB = cleanAL(b.author || '');
        return authA.localeCompare(authB, 'ar');
    });
    localStorage.setItem('R_' + curP, JSON.stringify(recs));
    localStorage.setItem('L_P', JSON.stringify(projs));
    localStorage.setItem('L_A', curP);
    const uniqueSubs = [...new Set(recs.map(r => r.subject))].filter(x=>x).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b), 'ar'));
    document.getElementById('subjectsList').innerHTML = uniqueSubs.map(s => `<option value="${s}">`).join('');
    let counter = 1;
    document.getElementById('adminBody').innerHTML = recs.map((r, i) => {
        r.finalID = (r.see || r.see_also) && !r.title ? null : counter++;
        let info = r.title ? `<b>${r.author || ''}</b> - ${r.title}` : (r.see ? `انظر: ${r.see}` : `انظر أيضاً: ${r.see_also}`);
        return `<tr><td>${r.finalID || '-'}</td><td>${r.subject}</td><td>${info}</td><td><button onclick="edit(${i})">تعديل</button><button onclick="deleteRec(${i})" style="color:red">حذف</button></td></tr>`;
    }).join('');
    document.getElementById('pSel').innerHTML = projs.map(p=>`<option ${p===curP?'selected':''}>${p}</option>`).join('');
}

function exportX() {
    if (recs.length === 0) { alert("لا توجد بيانات لتصديرها"); return; }
    try {
        const ws = XLSX.utils.json_to_sheet(recs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `${curP}.xlsx`);
    } catch (e) { alert("حدث خطأ في التصدير."); }
}

function openBiblioWindow() {
    const win = window.open('', '_blank');
    let content = `<html dir="rtl"><head><title>المعاينة</title><style>
        body{font-family:'Times New Roman', serif;padding:40px;line-height:1.6; font-size: 14pt;}
        .sub{background:#e0e0e0;text-align:center;padding:8px;margin:20px 0;font-weight:bold;border:1px solid #000;}
        .see-also-line{margin:-15px 0 20px 0; font-weight:bold; text-align:right;}
        .orig-title{display:block; margin:5px 0; font-style:italic; color:#444; font-size: 12pt;}
        .ent{margin-bottom:18px; border-bottom:1px solid #ddd; padding-bottom:12px;}
    </style></head><body>`;
    const usedSubjects = new Set(recs.filter(r => r.title).map(r => r.subject.trim()));
    let lastSub = '';
    recs.forEach(r => {
        if (!r.title && r.see) {
            if (usedSubjects.has(r.see.trim())) { content += `<div class="sub">${r.subject} انظر: ${r.see}</div>`; lastSub = r.subject; }
            return;
        }
        if (r.subject !== lastSub) {
            content += `<div class="sub">${r.subject}</div>`; lastSub = r.subject;
            let sa = recs.find(x => x.subject === r.subject && x.see_also);
            if (sa && usedSubjects.has(sa.see_also.trim())) content += `<div class="see-also-line">انظر أيضاً: ${sa.see_also}</div>`;
        }
        if (r.title) {
            let respStr = [r.author_preview, r.collab].filter(x=>x).join('، ');
            if(r.translator) respStr += (respStr ? ' ؛ ترجمة ' : 'ترجمة ') + r.translator;
            if(r.editor) respStr += (respStr ? ' ؛ ' : '') + r.editor;
            let line = `<b>${r.author || ''} (${r.finalID})</b><br>${r.title}`;
            line += respStr ? ` / ${respStr} . ـــ ` : ` . ـــ `;
    let bibTail = "";
        if (r.journal) {
            // تنسيق المجلة: دمج العدد والسنة بفاصلة ثم الباقي بشرطة نقطية
            let issueYear = [r.issue, r.year].filter(x => x).join(" ، ");
            bibTail = [r.journal, issueYear, r.pages ? "ص " + r.pages : ""]
                       .filter(x => x).join(" . ـــ ");
        }
    } else {
        // تنسيق الكتاب: يضع (:) بين المكان والناشر و (،) قبل السنة
        let pubInfo = [r.place, r.publisher].filter(x => x).join(" : ");
        let yearInfo = r.year ? " ، " + r.year : "";
        let pagesInfo = r.pages ? " . ـــ " + r.pages + " ص" : "";
        bibTail = pubInfo + yearInfo + pagesInfo;
    }
            let orig = r.orig_title ? `<span class="orig-title">العنوان الأصلي: ${r.orig_title}</span>` : '';
            content += `<div class="ent">${line}${bibTail}.${orig}</div>`;
        }
    });
    win.document.write(content + '</body></html>'); win.document.close();
}

function splitSlash(str) { return str ? str.split('/').map(s => s.trim()).filter(s => s) : []; }
function runIdx(f, l) {
    let m = {}; const used = new Set(recs.filter(r => r.title).map(r => r.subject.trim()));
    recs.forEach(r => { 
        let rawV = r[f] ? r[f].trim() : '';
        if (rawV) {
            let values = (f === 'subject') ? [rawV] : splitSlash(rawV);
            values.forEach(v => {
                if (f === 'subject') {
                    if (r.see && used.has(r.see.trim())) v = `${v} انظر: ${r.see}`;
                    else if (r.see_also && used.has(r.see_also.trim())) v = `${v} انظر أيضاً: ${r.see_also}`;
                    else if (!r.title) return;
                }
                if(!m[v]) m[v] = []; if(r.finalID && !m[v].includes(r.finalID)) m[v].push(r.finalID);
            });
        }
    });
    renderIdx(m, l);
}
function runAuthorIdx() {
    let m = {};
    recs.forEach(r => {
        if (r.finalID) {
            let names = [...new Set(splitSlash(r.author).concat(splitSlash(r.collab_idx)))];
            names.forEach(n => { if(!m[n]) m[n]=[]; if(!m[n].includes(r.finalID)) m[n].push(r.finalID); });
        }
    });
    renderIdx(m, "المؤلفين");
}
function journalIdx() {
    let m = {}; let affs = {};
    recs.forEach(r => { if(r.journal && r.affiliation) affs[r.journal.trim()] = r.affiliation.trim(); });
    recs.forEach(r => { if(r.journal && r.finalID) { 
        let j = r.journal.trim(); 
        let k = j + (r.affiliation ? ` (${r.affiliation})` : (affs[j] ? ` (${affs[j]})` : ""));
        if(!m[k]) m[k]=[]; if(!m[k].includes(r.finalID)) m[k].push(r.finalID);
    }});
    renderIdx(m, "المجلات");
}
function save() { 
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value.trim()); 
    if(!d.subject) { alert("رأس الموضوع إلزامي"); return; } 
    if (editIndex > -1) recs[editIndex] = d; else recs.push(d); 
    editIndex = -1; draw(); document.getElementById('bForm').reset(); 
}
function edit(i) { editIndex = i; let r = recs[i]; document.querySelectorAll('.in').forEach(inp => inp.value = r[inp.id] || ''); window.scrollTo(0,0); }
function deleteRec(i) { if(confirm("حذف؟")) { recs.splice(i, 1); draw(); } }
function closeM() { document.getElementById('modalOverlay').style.display='none'; }
function renderIdx(m, title) {
    let k = Object.keys(m).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b),'ar'));
    let h = `<h2 style="text-align:center;">كشاف ${title}</h2><div class="column-wrapper">`;
    k.forEach(x => h += `<div>${x} (${m[x].join(', ')})</div>`);
    document.getElementById('modalBody').innerHTML = h + `</div>`;
    document.getElementById('modalOverlay').style.display='block';
}
function newP() { let n = prompt("المشروع الجديد:"); if(n) { if(!projs.includes(n)) projs.push(n); curP=n; recs=[]; draw(); } }
function switchP(v) { curP=v; recs=JSON.parse(localStorage.getItem('R_'+v))||[]; draw(); }
function delP() { if(confirm("حذف؟")) { projs = projs.filter(p=>p!==curP); curP=projs[0]||'مشروع_1'; recs=JSON.parse(localStorage.getItem('R_'+curP))||[]; draw(); } }
function importX(e) { 
    const reader = new FileReader(); 
    reader.onload = (evt) => { 
        try {
            const workbook = XLSX.read(evt.target.result, {type:'binary'});
            recs = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            draw(); 
        } catch (err) { alert("خطأ في قراءة ملف الإكسل"); }
    }; 
    reader.readAsBinaryString(e.target.files[0]); 
}

window.onload = draw;
</script>
</body>
</html>
