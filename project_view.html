<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 5px; font-size: 11px; }
        .project-bar { background: #24292e; color: #fff; padding: 5px 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .dropdown { position: relative; display: inline-block; }
        .dropbtn { background: #444; color: white; padding: 4px 12px; font-size: 10px; border: 1px solid #666; cursor: pointer; border-radius: 2px; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1000; right: 0; }
        .dropdown-content button { color: black; padding: 8px 12px; display: block; width: 100%; border: none; text-align: right; background: none; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; }
        .dropdown-content button:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .compact-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; background: #fff; padding: 5px; border: 1px solid #ccc; }
        label { font-size: 9px; color: #555; font-weight: bold; margin-bottom: 1px; }
        input { border: 1px solid #bbb; padding: 2px; font-size: 12px; height: 18px; }
        .w-small { grid-column: span 1; } .w-med { grid-column: span 2; }
        .actions { margin: 5px 0; display: flex; gap: 4px; flex-wrap: wrap; }
        .btn { padding: 4px 10px; cursor: pointer; border: none; border-radius: 2px; color: #fff; font-weight: bold; font-size: 10px; }
        .btn-save { background: #28a745; } .btn-excel { background: #17a2b8; } .btn-word { background: #007bff; }
        .preview-table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 5px; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 1px 3px; text-align: right; font-size: 10px; height: 16px; }
        #smartModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border:2px solid #24292e; padding:15px; z-index:2000; box-shadow:0 0 20px rgba(0,0,0,0.5); width:400px; }
    </style>
</head>
<body>

<div class="project-bar">
    <div><strong>الفهرس الليبي الموحد</strong> | المشروع: <span id="activeProjectLabel" style="color:#ffc107"></span></div>
    <div style="display:flex; gap:10px;">
        <button onclick="document.getElementById('smartModal').style.display='block'" class="btn" style="background:#6f42c1">⚡ إدخال ذكي</button>
        <button onclick="createNewProject()" class="btn btn-save">+ مشروع جديد</button>
        <div class="dropdown">
            <button class="dropbtn">المشاريع المحفوظة ▼</button>
            <div id="projectDropdown" class="dropdown-content"></div>
        </div>
    </div>
</div>

<div id="smartModal">
    <textarea id="smartInput" style="width:100%; height:80px;" placeholder="الصق النص هنا..."></textarea><br>
    <button class="btn btn-save" onclick="processSmartPaste()">توزيع</button>
    <button class="btn" style="background:#dc3545" onclick="document.getElementById('smartModal').style.display='none'">إلغاء</button>
</div>

<form id="biblioForm" class="compact-grid">
    <div class="field-group w-med"><label>رأس الموضوع</label><input type="text" id="subject" class="in"></div>
    <div class="field-group w-med"><label>إحالة انظر</label><input type="text" id="see" class="in"></div>
    <div class="field-group w-med"><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in"></div>
    <div class="field-group w-med"><label>المؤلف</label><input type="text" id="author" class="in"></div>
    <div class="field-group w-med"><label>العنوان</label><input type="text" id="title" class="in"></div>
    <div class="field-group w-med"><label>المشاركون/المترجمون</label><input type="text" id="collab" class="in"></div>
    <div class="field-group w-small"><label>الطبعة</label><input type="text" id="edition" class="in"></div>
    <div class="field-group w-med"><label>مكان النشر</label><input type="text" id="place" class="in"></div>
    <div class="field-group w-med"><label>الناشر</label><input type="text" id="publisher" class="in"></div>
    <div class="field-group w-small"><label>السنة</label><input type="text" id="year" class="in"></div>
    <div class="field-group w-small"><label>صفحات</label><input type="text" id="pages" class="in"></div>
    <div class="field-group w-med"><label>السلسلة</label><input type="text" id="series" class="in"></div>
    <div class="field-group w-med"><label>عنوان أصلي</label><input type="text" id="orig_title" class="in"></div>
    <div class="field-group w-med"><label>مؤلف أصلي</label><input type="text" id="orig_author" class="in"></div>
    <div class="field-group w-med"><label>جهة الإصدار</label><input type="text" id="org" class="in"></div>
    <div class="field-group w-small"><label>عدد المؤلفين</label><input type="number" id="count" class="in"></div>
    <div class="field-group w-small"><label>التبعية</label><input type="text" id="affil" class="in"></div>
    <div class="field-group w-small"><label>الدولة</label><input type="text" id="country" class="in"></div>
</form>

<div class="actions">
    <button class="btn btn-save" onclick="saveData()">حفظ (Enter)</button>
    <button class="btn btn-excel" onclick="exportTemplate()">تصدير قالب Excel</button>
    <button class="btn btn-excel" style="background:#6f42c1" onclick="document.getElementById('importFile').click()">استيراد Excel</button>
    <input type="file" id="importFile" style="display:none" onchange="importFromExcel(event)">
    <button class="btn btn-word" onclick="previewFullList()">معاينة القائمة (Word)</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('author')">كشاف المؤلفين</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('collab')">كشاف المترجمين</button>
    <button class="btn btn-word" style="background:#555" onclick="previewIndex('title')">كشاف العناوين</button>
    <button class="btn btn-word" style="background:#d94a38" onclick="previewIndex('orig_title')">كشاف العنوان الأصلي</button>
</div>

<table class="preview-table"><tbody id="tableBody"></tbody></table>

<script>
let projects = JSON.parse(localStorage.getItem('lib_proj_list')) || ['المشروع_1'];
let currentProj = localStorage.getItem('lib_active_proj') || 'المشروع_1';
let records = JSON.parse(localStorage.getItem('recs_' + currentProj)) || [];
let editIdx = -1;

function createNewProject() {
    let name = prompt("اسم المشروع الجديد:");
    if(name && !projects.includes(name)) { projects.push(name); localStorage.setItem('lib_proj_list', JSON.stringify(projects)); switchProject(name); }
}
function switchProject(name) { localStorage.setItem('lib_active_proj', name); location.reload(); }
function renderProjectDropdown() {
    document.getElementById('activeProjectLabel').innerText = currentProj;
    document.getElementById('projectDropdown').innerHTML = projects.map(p => `<button onclick="switchProject('${p}')">${p === currentProj ? '✓ ' : ''}${p}</button>`).join('');
}

function formatEntry(r) {
    let p = [];
    if(r.author) p.push(`<span style="font-weight:bold">${r.author}</span>`);
    let titleStyle = (!r.author) ? 'font-weight:bold' : '';
    if(r.title) p.push(`. <span style="${titleStyle}">${r.title}</span>`);
    if(r.collab) p.push(`؛ ${r.collab}`);
    if(r.edition) p.push(`. - ط ${r.edition}`);
    if(r.place || r.publisher || r.year) {
        let pub = ". - ";
        if(r.place) pub += r.place;
        if(r.publisher) pub += ": " + r.publisher;
        if(r.year) pub += "، " + r.year;
        p.push(pub);
    }
    if(r.pages) p.push(`. - ص ص ${r.pages}`);
    if(r.series) p.push(`. - (${r.series})`);
    if(r.country) p.push(`. - (${r.country})`);
    return p.join('').replace(/^\. /, "");
}

function previewFullList() {
    let win = window.open('', '', 'width=900,height=700');
    let serial = 1; let lastSubject = "";
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; font-size:12pt;">`;
    records.forEach(r => {
        if(r.subject !== lastSubject) {
            content += `<div style="text-align:center; background:#ddd; font-weight:bold; padding:5px; margin-top:20pt;">${r.subject}</div>`;
            lastSubject = r.subject;
        }
        if(r.see || r.see_also) {
            let label = r.see ? "أنظر" : "أنظر أيضاً";
            content += `<div style="text-align:center; background:#f0f0f0; padding:3px; margin:5px 0;">${label}: ${r.see || r.see_also}</div>`;
        } else {
            let entry = formatEntry(r);
            let authorLine = r.author ? `<div style="font-weight:bold;">${r.author} <span style="float:left">(${serial})</span></div>` : "";
            let remaining = r.author ? entry.replace(`<span style="font-weight:bold">${r.author}</span>`, "").replace(/^\. /, "") : entry + ` <span style="float:left">(${serial})</span>`;
            content += `<div style="margin-bottom:15pt;">${authorLine}<div>${remaining}</div><div style="clear:both"></div></div>`;
            serial++;
        }
    });
    content += `</div>`; win.document.write(content);
}

function previewIndex(type) {
    let win = window.open('', '', 'width=900,height=700');
    let content = `<div dir="rtl" style="font-family:'Times New Roman', serif; padding:1in; column-count:2; font-size:11pt;">`;
    let map = {}; let serial = 1;
    records.forEach(r => { if(!r.see && !r.see_also) { (r[type]||"").split('؛').forEach(v => { v=v.trim(); if(v){ if(!map[v]) map[v]=[]; map[v].push(serial); }}); serial++; }});
    Object.keys(map).sort((a,b)=>a.localeCompare(b,'ar')).forEach(k => {
        content += `<div style="border-bottom:0.5pt solid #eee; margin-bottom:4pt;">${k} <span style="float:left; font-weight:bold;">(${map[k].join(')( ')})</span><div style="clear:both"></div></div>`;
    });
    content += `</div>`; win.document.write(content);
}

function saveData() {
    let data = {}; document.querySelectorAll('.in').forEach(f => data[f.id] = f.value.trim());
    if(!data.subject) return alert("الرأس مطلوب");
    if(editIdx > -1) records[editIdx] = data; else records.push(data);
    editIdx = -1; sortData(); updateUI(); document.getElementById('biblioForm').reset();
}
function sortData() { records.sort((a,b) => a.subject.replace(/^ال/,'').localeCompare(b.subject.replace(/^ال/,''),'ar')); }
function updateUI() {
    localStorage.setItem('recs_'+currentProj, JSON.stringify(records));
    let h = ''; let s = 1;
    records.forEach((r,i) => { h += `<tr><td>${r.see||r.see_also?'--':s++}</td><td style="font-weight:bold">${r.subject}</td><td>${formatEntry(r)}</td><td><button onclick="editRec(${i})">تعديل</button></td></tr>`; });
    document.getElementById('tableBody').innerHTML = h;
}
function editRec(i) { editIdx = i; Object.keys(records[i]).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = records[i][k]; }); }
function processSmartPaste() {
    let t = document.getElementById('smartInput').value;
    let parts = t.split('.'); document.getElementById('author').value = parts[0].trim();
    document.getElementById('title').value = (parts[1]||"").trim();
    document.getElementById('smartModal').style.display='none';
}
window.onload = () => { renderProjectDropdown(); updateUI(); };
</script>
</body>
</html>
