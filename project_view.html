<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #eceef1; margin: 0; padding: 0; overflow-x: hidden; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; border-bottom: 2px solid #000; }
        .input-table { width: 100%; background: #cfcfcf; border-spacing: 1px; padding: 1px; table-layout: fixed; }
        input { width: 100%; height: 22px; font-size: 12px; font-weight: bold; border: 1px solid #999; text-align: right; box-sizing: border-box; }
        
        .w-xs { width: 50px !important; }
        .w-sm { width: 80px !important; }
        
        .smart-row { display: flex; background: #bdc3c7; padding: 2px; gap: 5px; align-items: center; border-bottom: 1px solid #7f8c8d; }
        .actions { background: #cfcfcf; text-align: center; padding: 2px; display: flex; justify-content: center; align-items: center; gap: 3px; border-bottom: 2px solid #2c3e50; }
        .btn { padding: 2px 6px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 11px; font-weight: bold; }
        
        .scroll-area { margin-top: 175px; height: calc(100vh - 180px); overflow-y: auto; padding: 5px; box-sizing: border-box; }
        .admin-table { border-collapse: collapse; background: #fff; font-size: 11px; width: 100%; table-layout: fixed; }
        .admin-table th { position: sticky; top: 0; background: #34495e; color: white; z-index: 100; padding: 4px; border: 1px solid #2c3e50; }
        .admin-table td { border: 1px solid #ccc; padding: 3px; text-align: right; word-wrap: break-word; }
        
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; }
        .modal-content { background:white; width:90%; margin:1% auto; padding:20px; height: 85vh; overflow-y: auto; }
        
        .column-wrapper { column-count: 2; column-gap: 30px; }
        .idx-group { break-inside: avoid; margin-bottom: 10px; }
        .idx-letter { background: #7f8c8d; color: white; padding: 2px 8px; font-weight: bold; display: block; margin-bottom: 3px; }
        .idx-item { margin-bottom: 2px; border-bottom: 1px solid #eee; padding: 2px; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:2px 10px; height: 25px;">
        <strong style="font-size:11px;">الفهرس الليبي الموحد</strong>
        <div style="display:flex; gap:3px;">
            <button onclick="document.getElementById('xlIn').click()" class="btn" style="background:#e67e22">استيراد</button>
            <button onclick="exportX()" class="btn" style="background:#2980b9">تصدير</button>
            <input type="file" id="xlIn" style="display:none" onchange="importX(event)">
            <button onclick="newP()" class="btn" style="background:#27ae60">+ مشروع</button>
            <select id="pSel" onchange="switchP(this.value)" style="font-size:10px;"></select>
            <button onclick="delP()" class="btn" style="background:#c0392b">حذف</button>
        </div>
    </div>

    <form id="bForm">
        <datalist id="subjectsList"></datalist>
        <table class="input-table">
            <tr>
                <td style="width:15%"><input type="text" id="subject" class="in" list="subjectsList" placeholder="رأس الموضوع"></td>
                <td style="width:15%"><input type="text" id="see" class="in" placeholder="إحالة انظر"></td>
                <td style="width:20%"><input type="text" id="see_also" class="in" placeholder="إحالة انظر أيضاً"></td>
                <td style="width:25%"><input type="text" id="author_preview" class="in" placeholder="مؤلف معاينة"></td>
                <td style="width:25%"><input type="text" id="author" class="in" placeholder="المؤلف (مقلوب)"></td>
            </tr>
            <tr>
                <td colspan="3"><input type="text" id="title" class="in" placeholder="العنوان"></td>
                <td style="width:25%"><input type="text" id="collab" class="in" placeholder="مشارك معاينة"></td>
                <td style="width:25%"><input type="text" id="collab_idx" class="in" placeholder="مشارك كشاف"></td>
            </tr>
            <tr>
                <td class="w-xs"><input type="text" id="edition" class="in" placeholder="طبعة"></td>
                <td><input type="text" id="journal" class="in" placeholder="المجلة"></td>
                <td class="w-xs"><input type="text" id="issue" class="in" placeholder="العدد"></td>
                <td><input type="text" id="affiliation" class="in" placeholder="التبعية"></td>
                <td><input type="text" id="place" class="in" placeholder="مكان النشر"></td>
                <td><input type="text" id="publisher" class="in" placeholder="الناشر"></td>
                <td class="w-sm"><input type="text" id="year" class="in" placeholder="سنة"></td>
            </tr>
            <tr>
                <td><input type="text" id="series" class="in" placeholder="السلسلة"></td>
                <td><input type="text" id="orig_title" class="in" placeholder="العنوان الأصلي"></td>
                <td><input type="text" id="editor" class="in" placeholder="محقق/مراجعة"></td>
                <td class="w-sm"><input type="text" id="material_type" class="in" placeholder="نوع المادة"></td>
                <td class="w-sm"><input type="text" id="pages" class="in" placeholder="صفحات"></td>
                <td><input type="text" id="translator" class="in" placeholder="مترجم معاينة"></td>
                <td><input type="text" id="trans_idx" class="in" placeholder="مترجم كشاف"></td>
            </tr>
        </table>
        
        <div class="smart-row">
            <input type="text" id="url" class="in" placeholder="الرابط (URL)" style="flex: 2;">
            <div style="width:1px; background:#999; height:15px;"></div>
            <input type="text" id="smartInput" placeholder="لصق ذكي هنا للتوزيع..." style="flex: 1; font-size:10px; background:#f9f9f9;">
            <button type="button" class="btn" style="background:#16a085" onclick="processSmart()">توزيع</button>
        </div>

        <div class="actions">
            <button type="button" id="saveBtn" class="btn" style="background:#27ae60" onclick="save()">حفظ السجل</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="openBiblioWindow()">المعاينة</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="runIdx('author', 'المؤلفين')">كشاف المؤلفين</button>
            <button type="button" class="btn" style="background:#d35400" onclick="runIdx('title', 'العناوين')">كشاف العناوين</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="runIdx('trans_idx', 'المترجمين')">كشاف المترجمين</button>
            <button type="button" class="btn" style="background:#16a085" onclick="journalIdx()">قائمة المجلات</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="runIdx('subject', 'الموضوعات')">رؤوس الموضوعات</button>
        </div>
    </form>
</div>

<div id="modalOverlay"><button onclick="closeM()" class="btn" style="background:#c0392b; margin:10px;">إغلاق</button><div class="modal-content" id="modalBody"></div></div>
<div class="scroll-area"><table class="admin-table"><thead><tr><th style="width:30px;">رقم</th><th style="width:100px;">رأس الموضوع</th><th>البيانات البيبليوغرافية</th><th style="width:80px;">إجراء</th></tr></thead><tbody id="adminBody"></tbody></table></div>

<script>
let projs = JSON.parse(localStorage.getItem('L_P')) || ['مشروع_1'];
let curP = localStorage.getItem('L_A') || 'مشروع_1';
let recs = JSON.parse(localStorage.getItem('R_' + curP)) || [];
let editIndex = -1;
const cleanAL = (s) => s ? s.replace(/^(ال)/, '').trim() : '';

function draw() {
    recs.sort((a, b) => cleanAL(a.subject).localeCompare(cleanAL(b.subject), 'ar'));
    localStorage.setItem('R_' + curP, JSON.stringify(recs));
    localStorage.setItem('L_P', JSON.stringify(projs));
    localStorage.setItem('L_A', curP);
    let entryCounter = 1;
    let hBody = recs.map((r, i) => {
        let isRef = (r.see || r.see_also) && !r.title;
        r.finalID = isRef ? null : entryCounter++;
        return `<tr><td>${r.finalID || '-'}</td><td>${r.subject}</td><td><b>${r.author || ''}</b> - ${r.title || 'إحالة'}</td>
        <td><button onclick="edit(${i})">تعديل</button><button onclick="deleteRec(${i})">حذف</button></td></tr>`;
    }).join('');
    document.getElementById('adminBody').innerHTML = hBody;
    document.getElementById('pSel').innerHTML = projs.map(p=>`<option ${p===curP?'selected':''}>${p}</option>`).join('');
}

function processSmart() {
    let v = document.getElementById('smartInput').value;
    if(!v) return;
    let p = v.split(/[؛\.\|\-,]\s|؛/).map(x => x.trim());
    const fields = ['author', 'author_preview', 'title', 'collab', 'translator', 'place', 'publisher', 'year'];
    p.forEach((val, i) => { if(fields[i]) document.getElementById(fields[i]).value = val; });
}

function runIdx(f, l) {
    let m = {}; 
    recs.forEach(r => { 
        if(r[f] && r.finalID) {
            // تقسيم الأسماء بناءً على الفواصل المحددة (، أو ؛)
            r[f].split(/[،؛]/).forEach(n => { 
                n = n.trim(); 
                if(n) { 
                    if(!m[n]) m[n] = []; 
                    if(!m[n].includes(r.finalID)) m[n].push(r.finalID); 
                }
            }); 
        }
    });
    let k = Object.keys(m).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b),'ar'));
    let groups = {}; k.forEach(x => { let c = cleanAL(x).charAt(0); if(!groups[c]) groups[c]=[]; groups[c].push({key:x, ids:m[x]}); });
    let h = `<h3>كشاف ${l}</h3><div class="column-wrapper">`;
    for(let c in groups) { h += `<div class="idx-group"><span class="idx-letter">${c}</span>` + groups[c].map(i => `<div class="idx-item"><b>${i.key}</b> (${i.ids.join(', ')})</div>`).join('') + `</div>`; }
    document.getElementById('modalBody').innerHTML = h + `</div>`; document.getElementById('modalOverlay').style.display='block';
}

function journalIdx() {
    let m = {}; 
    let journalAffiliations = {};
    
    // بناء قاموس للمجلات والتبعية المسجلة لها
    recs.forEach(r => {
        if(r.journal && r.affiliation) {
            journalAffiliations[r.journal.trim()] = r.affiliation.trim();
        }
    });

    recs.forEach(r => { 
        if(r.journal && r.finalID) { 
            let jName = r.journal.trim();
            // استخدام التبعية المسجلة مسبقاً إذا كانت خانة التبعية الحالية فارغة
            let aff = r.affiliation ? r.affiliation.trim() : (journalAffiliations[jName] || "");
            let k = jName + (aff ? ` (${aff})` : ""); 
            if(!m[k]) m[k]=[]; 
            m[k].push(r.finalID); 
        }
    });
    let k = Object.keys(m).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b),'ar'));
    let groups = {}; k.forEach(x => { let c = cleanAL(x).charAt(0); if(!groups[c]) groups[c]=[]; groups[c].push({key:x, ids:m[x]}); });
    let h = `<h3>قائمة المجلات والتبعية</h3><div class="column-wrapper">`;
    for(let c in groups) { h += `<div class="idx-group"><span class="idx-letter">${c}</span>` + groups[c].map(i => `<div class="idx-item"><b>${i.key}</b> (${i.ids.join(', ')})</div>`).join('') + `</div>`; }
    document.getElementById('modalBody').innerHTML = h + `</div>`; document.getElementById('modalOverlay').style.display='block';
}

function openBiblioWindow() {
    const win = window.open('', '_blank');
    let content = `<html dir="rtl"><head><style>
        body { font-family: 'Times New Roman', serif; padding: 30px; line-height: 1.4; }
        .sub { background: #e0e0e0; text-align: center; padding: 5px; margin: 15px 0 5px; font-size: 14pt; font-weight: bold; border: 1px solid #999; }
        .ent { margin-bottom: 12px; font-size: 13pt; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .bold-title { font-weight: bold; }
    </style></head><body>`;

    let lastSub = '';
    recs.forEach(r => {
        if (r.subject !== lastSub) { content += `<div class="sub">${r.subject}</div>`; lastSub = r.subject; }
        if (r.see) content += `<div style="margin-bottom:5px;">انظر: ${r.see}</div>`;
        if (r.see_also) content += `<div style="margin-bottom:5px;">انظر أيضاً: ${r.see_also}</div>`;
        
        if (r.title) {
            let titleClass = !r.author ? 'bold-title' : '';
            let resp = [r.author_preview, r.collab].filter(x => x).join('، ');
            if(r.translator) resp += (resp ? '؛ ترجمة ' : 'ترجمة ') + r.translator;
            if(r.editor) resp += (resp ? '؛ ' : '') + r.editor;

            let line = `<b>${r.author || ''} (${r.finalID})</b><br><span class="${titleClass}">${r.title}</span>`;
            if(resp) line += ` / ${resp}`;
            if(r.edition) line += ` . ـــ ط. ${r.edition}`;
            
            if(r.journal) {
                line += ` . ـــ ${r.journal}${r.issue ? ' . ـــ ' + r.issue : ''}`;
            } else {
                let pInfo = [r.place, r.publisher, r.year].filter(x => x).join(': ');
                if(pInfo) line += ` . ـــ ${pInfo}`;
            }
            if(r.pages) line += ` . ـــ ${r.journal ? 'ص ' + r.pages : r.pages + ' ص'}`;
            if(r.url) line += `<br><small style="color:blue;">متاح على: ${r.url}</small>`;
            content += `<div class="ent">${line}.</div>`;
        }
    });
    win.document.write(content + '</body></html>'); win.document.close();
}

function save() {
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value.trim());
    if(!d.subject) return alert("الرأس مطلوب");
    if (editIndex > -1) { recs[editIndex] = d; editIndex = -1; } else { recs.push(d); }
    draw(); document.getElementById('bForm').reset();
}

function edit(i) { editIndex = i; let r = recs[i]; document.querySelectorAll('.in').forEach(inp => inp.value = r[inp.id] || ''); window.scrollTo(0,0); }
function deleteRec(i) { if(confirm("حذف؟")) { recs.splice(i, 1); draw(); } }
function newP() { let n = prompt("اسم المشروع:"); if(n) { projs.push(n); curP=n; recs=[]; draw(); } }
function switchP(v) { curP=v; recs=JSON.parse(localStorage.getItem('R_'+v))||[]; draw(); }
function closeM() { document.getElementById('modalOverlay').style.display='none'; }
function exportX() { const ws = XLSX.utils.json_to_sheet(recs); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, `Fahras_${curP}.xlsx`); }
window.onload = draw;
</script>
</body>
</html>
