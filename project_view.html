<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceef1; margin: 0; padding: 0; font-size: 10px; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; padding-bottom: 2px; }
        
        /* تنسيقك الأصلي الذي أرسلته */
        .compact-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; background: #fff; padding: 4px; border: 1px solid #ccc; border-radius: 4px; margin-top: 1px; }
        label { font-size: 9px; font-weight: bold; color: #555; text-align: center; display: block; margin-bottom: 1px; }
        input, select { width: 100%; border: 1px solid #bbb; padding: 1px 4px; font-size: 10px; height: 18px; text-align: right; border-radius: 2px; box-sizing: border-box; background: #fdfdfd; }
        
        .actions { margin: 2px 0; display: flex; gap: 3px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 3px 10px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-weight: bold; font-size: 9px; }
        .btn-save { background: #27ae60; } 
        .btn-smart { background: #f39c12; }
        .btn-proj { background: #2980b9; }

        .preview-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; }
        .preview-table td { border: 1px solid #ccc; padding: 2px; text-align: right; font-size: 10px; line-height: 1.2; }
        .short-in { width: 50px !important; display: block; margin: 0 auto; }
        
        .scroll-content { margin-top: 135px; height: calc(100vh - 135px); overflow-y: auto; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:2px 10px;">
        <strong style="font-size:11px;">الفهرس الليبي الموحد</strong>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="addProject()" class="btn btn-proj">+ مشروع</button>
            <select id="projSelect" onchange="switchProject(this.value)" style="height:16px; font-size:9px; width:100px;"></select>
            <button onclick="deleteProject()" class="btn" style="background:#c0392b">حذف</button>
        </div>
    </div>

    <form id="biblioForm">
        <div class="compact-grid">
            <div><label>رأس الموضوع</label><input type="text" id="subject" class="in" list="subList"></div>
            <div><label>إحالة انظر</label><input type="text" id="see" class="in"></div>
            <div><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in"></div>
            <div><label>المؤلف</label><input type="text" id="author" class="in"></div>
            <div><label>العنوان</label><input type="text" id="title" class="in"></div>
            <div><label>المشاركون</label><input type="text" id="collab" class="in"></div>
        </div>
        <div class="compact-grid">
            <div><label>مكان النشر</label><input type="text" id="place" class="in"></div>
            <div><label>الناشر / المجلة</label><input type="text" id="publisher" class="in"></div>
            <div><label>السنة</label><input type="text" id="year" class="in short-in"></div>
            <div><label>المترجم</label><input type="text" id="translator" class="in"></div>
            <div><label>محقق/مراجعة</label><input type="text" id="editor" class="in"></div>
            <div><label>صفحات</label><input type="text" id="pages" class="in short-in"></div>
        </div>
        <div class="actions">
            <button type="button" class="btn btn-save" onclick="saveData()">حفظ السجل</button>
            <button type="button" class="btn btn-smart" onclick="openSmart()">إدخال ذكي</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="previewFull()">معاينة القائمة</button>
        </div>
    </form>
</div>

<div class="scroll-content">
    <table class="preview-table"><tbody id="tableBody"></tbody></table>
</div>

<div id="smartModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border:2px solid #2c3e50; padding:10px; z-index:9999;">
    <textarea id="smartInput" style="width:300px; height:60px;"></textarea><br>
    <button onclick="processSmart()" class="btn btn-save">توزيع</button>
    <button onclick="closeSmart()" class="btn" style="background:#555">إلغاء</button>
</div>

<script>
let projects = JSON.parse(localStorage.getItem('lib_projs')) || ['مشروع_1'];
let current = localStorage.getItem('lib_active') || 'مشروع_1';
let records = JSON.parse(localStorage.getItem('recs_' + current)) || [];

function draw() {
    localStorage.setItem('recs_' + current, JSON.stringify(records));
    localStorage.setItem('lib_projs', JSON.stringify(projects));
    localStorage.setItem('lib_active', current);
    
    let h = '';
    records.forEach((r, i) => {
        h += `<tr>
            <td width="20">${i+1}</td>
            <td width="120"><b>${r.subject}</b></td>
            <td>${r.author || ''} - ${r.title || ''}</td>
            <td width="30"><button onclick="editRec(${i})" style="font-size:8px;">تعديل</button></td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = h;
    document.getElementById('projSelect').innerHTML = projects.map(p=>`<option ${p===current?'selected':''}>${p}</option>`).join('');
}

function saveData() {
    let d = {}; 
    document.querySelectorAll('.in').forEach(i => d[i.id] = i.value);
    if(!d.subject) return;
    records.push(d);
    records.sort((a,b) => a.subject.localeCompare(b.subject, 'ar'));
    draw();
    document.getElementById('biblioForm').reset();
}

function addProject() {
    let n = prompt("اسم المشروع الجديد:");
    if(n) { projects.push(n); current = n; records = []; draw(); }
}

function switchProject(v) {
    current = v;
    records = JSON.parse(localStorage.getItem('recs_' + v)) || [];
    draw();
}

function deleteProject() {
    if(confirm("حذف المشروع؟")) {
        localStorage.removeItem('recs_' + current);
        projects = projects.filter(p => p !== current);
        current = projects[0] || 'مشروع_1';
        records = JSON.parse(localStorage.getItem('recs_' + current)) || [];
        draw();
    }
}

function openSmart() { document.getElementById('smartModal').style.display='block'; }
function closeSmart() { document.getElementById('smartModal').style.display='none'; }
function processSmart() {
    let t = document.getElementById('smartInput').value;
    let p = t.split('/');
    if(p[0]) document.getElementById('author').value = p[0].trim();
    if(p[1]) document.getElementById('title').value = p[1].split('.')[0].trim();
    closeSmart();
}

function editRec(i) {
    let r = records[i];
    Object.keys(r).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = r[k]; });
    records.splice(i, 1);
}

window.onload = draw;
</script>
<datalist id="subList"></datalist>
</body>
</html>
