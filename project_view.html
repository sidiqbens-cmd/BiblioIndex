<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #eceef1; margin: 0; padding: 0; font-size: 11px; }
        .header-box { position: fixed; top: 0; width: 100%; background: #2c3e50; z-index: 999; color: white; padding: 5px 0; }
        
        /* إجبار الشبكة على 7 أعمدة أفقية */
        .grid-row { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            background: #cfcfcf; 
            padding: 5px 10px;
        }
        
        .grid-row div { display: flex; flex-direction: column; }
        label { font-size: 10px; font-weight: bold; color: #333; margin-bottom: 2px; }
        input { border: 1px solid #999; padding: 2px; font-size: 11px; height: 22px; border-radius: 2px; width: 100%; box-sizing: border-box; }
        
        .actions-bar { background: #cfcfcf; padding: 5px; text-align: center; border-bottom: 2px solid #2c3e50; }
        .btn { padding: 4px 10px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 10px; font-weight: bold; margin: 0 2px; }
        
        .content { margin-top: 180px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        table td { border: 1px solid #ccc; padding: 4px; font-size: 11px; text-align: right; }
        
        #smartModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border:2px solid #2c3e50; padding:15px; z-index:9999; width:400px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="header-box">
    <div style="display:flex; justify-content:space-between; padding:0 20px; align-items:center;">
        <strong>الفهرس الليبي الموحد</strong>
        <div>
            <button onclick="addProject()" class="btn" style="background:#27ae60">+ مشروع</button>
            <select id="projSelect" onchange="switchProject(this.value)" style="font-size:10px; height:20px;"></select>
            <button onclick="document.getElementById('smartModal').style.display='block'" class="btn" style="background:#2980b9">إدخال ذكي</button>
        </div>
    </div>

    <form id="biblioForm">
        <div class="grid-row">
            <div><label>رأس الموضوع</label><input type="text" id="subject" class="in" list="subList"></div>
            <div><label>إحالة انظر</label><input type="text" id="see" class="in"></div>
            <div><label>إحالة انظر أيضاً</label><input type="text" id="see_also" class="in"></div>
            <div><label>المؤلف (مقلوب)</label><input type="text" id="author" class="in"></div>
            <div><label>المؤلف (معاينة)</label><input type="text" id="author_preview" class="in"></div>
            <div><label>العنوان</label><input type="text" id="title" class="in"></div>
            <div><label>المشارك (معاينة)</label><input type="text" id="collab" class="in"></div>
        </div>
        <div class="grid-row">
            <div><label>المشارك (كشاف)</label><input type="text" id="collab_idx" class="in"></div>
            <div><label>المترجم (معاينة)</label><input type="text" id="translator" class="in"></div>
            <div><label>المترجم (كشاف)</label><input type="text" id="trans_idx" class="in"></div>
            <div><label>المجلة</label><input type="text" id="journal" class="in"></div>
            <div><label>الناشر</label><input type="text" id="publisher" class="in"></div>
            <div><label>مكان النشر</label><input type="text" id="place" class="in"></div>
            <div><label>التبعية</label><input type="text" id="affiliation" class="in"></div>
        </div>
        <div class="grid-row">
            <div><label>محقق/مراجعة</label><input type="text" id="editor" class="in"></div>
            <div><label>السلسلة</label><input type="text" id="series" class="in"></div>
            <div><label>عنوان أصلي</label><input type="text" id="orig_title" class="in"></div>
            <div><label>العدد</label><input type="text" id="issue" class="in"></div>
            <div><label>السنة</label><input type="text" id="year" class="in"></div>
            <div><label>طبعة</label><input type="text" id="edition" class="in"></div>
            <div><label>صفحات</label><input type="text" id="pages" class="in"></div>
        </div>
        <div class="actions-bar">
            <button type="button" class="btn" style="background:#27ae60" onclick="saveData()">حفظ السجل</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="previewAll()">المعاينة</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="deleteProject()">حذف المشروع</button>
        </div>
    </form>
</div>

<div id="smartModal">
    <h4>الإدخال الذكي</h4>
    <textarea id="smartInput" style="width:100%; height:80px;"></textarea><br><br>
    <button class="btn" style="background:#27ae60" onclick="runSmart()">توزيع</button>
    <button class="btn" style="background:#555" onclick="document.getElementById('smartModal').style.display='none'">إلغاء</button>
</div>

<div class="content">
    <table id="dataTable"></table>
</div>

<script>
let projects = JSON.parse(localStorage.getItem('p_list')) || ['افتراضي'];
let current = localStorage.getItem('p_active') || 'افتراضي';
let records = JSON.parse(localStorage.getItem('recs_' + current)) || [];
let editIdx = -1;

function updateUI() {
    localStorage.setItem('recs_'+current, JSON.stringify(records));
    localStorage.setItem('p_list', JSON.stringify(projects));
    localStorage.setItem('p_active', current);
    
    let h = ''; let s = 1;
    records.forEach((r, i) => {
        h += `<tr>
            <td width="30">${r.title ? s++ : '-'}</td>
            <td width="150"><b>${r.subject}</b></td>
            <td>${r.author || ''} ${r.title ? '- ' + r.title : ''} ${r.see ? '(انظر: '+r.see+')' : ''}</td>
            <td width="50"><button onclick="editRec(${i})">تعديل</button></td>
        </tr>`;
    });
    document.getElementById('dataTable').innerHTML = h;
    document.getElementById('projSelect').innerHTML = projects.map(p=>`<option ${p===current?'selected':''}>${p}</option>`).join('');
}

function saveData() {
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value);
    if(!d.subject) return alert("الرأس مطلوب");
    if(editIdx > -1) records[editIdx] = d; else records.push(d);
    editIdx = -1;
    records.sort((a,b) => a.subject.localeCompare(b.subject, 'ar'));
    updateUI(); document.getElementById('biblioForm').reset();
}

function editRec(i) {
    editIdx = i;
    Object.keys(records[i]).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = records[i][k]; });
}

function addProject() {
    let n = prompt("اسم المشروع:");
    if(n) { projects.push(n); current = n; records = []; updateUI(); }
}

function switchProject(v) { current = v; records = JSON.parse(localStorage.getItem('recs_'+v)) || []; updateUI(); }

function deleteProject() {
    if(confirm("حذف؟")) { localStorage.removeItem('recs_'+current); projects = projects.filter(p=>p!==current); current=projects[0] || 'افتراضي'; updateUI(); location.reload(); }
}

function runSmart() {
    let t = document.getElementById('smartInput').value;
    let p = t.split('/');
    if(p[0]) document.getElementById('author').value = p[0].trim();
    if(p[1]) document.getElementById('title').value = p[1].split('.')[0].trim();
    document.getElementById('smartModal').style.display='none';
}

window.onload = updateUI;
</script>
<datalist id="subList"></datalist>
</body>
</html>
