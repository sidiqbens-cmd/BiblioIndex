<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>BiblioIndex</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #eceef1; margin: 0; padding: 0; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; border-bottom: 2px solid #000; }
        .input-table { width: 100%; background: #cfcfcf; border-spacing: 2px; padding: 2px; table-layout: fixed; }
        label { font-size: 9px; font-weight: bold; color: #333; display: block; text-align: center; }
        input, select { width: 100%; height: 18px; font-size: 12px; border: 1px solid #999; text-align: right; background: #fff; }
        .w-sm { width: 60px !important; }
        .smart-zone { background: #bdc3c7; padding: 5px; display: flex; gap: 5px; align-items: center; border-bottom: 1px solid #7f8c8d; }
        .actions { background: #cfcfcf; text-align: center; padding: 4px; display: flex; justify-content: center; gap: 4px; border-bottom: 2px solid #2c3e50; }
        .btn { padding: 3px 8px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 10px; font-weight: bold; }
        .scroll-area { margin-top: 225px; height: calc(100vh - 230px); overflow: auto; }
        .admin-table { border-collapse: collapse; background: #fff; font-size: 11px; width: 100%; }
        .admin-table th { position: sticky; top: 0; background: #34495e; color: white; z-index: 100; padding: 5px; border: 1px solid #2c3e50; }
        .admin-table td { border: 1px solid #ccc; padding: 5px; text-align: right; vertical-align: top; }
        .btn-edit-row { background: #2980b9 !important; } 
        .btn-del-row { background: #c0392b !important; }
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; }
        .modal-content { background:white; width:90%; margin:1% auto; padding:25px; height: 90vh; overflow-y: auto; }
        .close-fixed { position: fixed; top: 20px; left: 60px; background: #c0392b; color: white; border: none; padding: 8px 20px; z-index: 3000; cursor:pointer; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:4px 15px;">
        <strong style="font-size:12px;">BiblioIndex</strong>
        <div style="display:flex; gap:6px;">
            <button onclick="document.getElementById('xlIn').click()" class="btn" style="background:#e67e22">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
            <button onclick="exportX()" class="btn" style="background:#2980b9">ğŸ’¾ ØªØµØ¯ÙŠØ±</button>
            <input type="file" id="xlIn" style="display:none" onchange="importX(event)">
            <button onclick="newP()" class="btn" style="background:#27ae60">+ Ù…Ø´Ø±ÙˆØ¹</button>
            <select id="pSel" onchange="switchP(this.value)" style="width:auto; height:22px;"></select>
            <button onclick="delP()" class="btn" style="background:#c0392b">Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
        </div>
    </div>

    <form id="bForm">
        <datalist id="subjectsList"></datalist>
        <table class="input-table">
            <tr>
                <td><label>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label><input type="text" id="subject" class="in" list="subjectsList"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø±</label><input type="text" id="see" class="in" list="subjectsList"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹</label><input type="text" id="see_also" class="in" list="subjectsList"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù…Ù‚Ù„ÙˆØ¨)</label><input type="text" id="author" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="author_preview" class="in"></td>
                <td><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="title" class="in"></td>
            </tr>
            <tr>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="collab" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="collab_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="translator" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="trans_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¬Ù„Ø©</label><input type="text" id="journal" class="in"></td>
                <td><label>Ø§Ù„Ø¹Ø¯Ø¯ (Ù…Ø¬ØŒ Ø¹ØŒ Ø´Ù‡Ø±)</label><input type="text" id="issue" class="in"></td>
            </tr>
            <tr>
                <td><label>Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø´Ø±</label><input type="text" id="place" class="in"></td>
                <td><label>Ø§Ù„ØªØ¨Ø¹ÙŠØ©/Ø§Ù„Ø¬Ù‡Ø©</label><input type="text" id="affiliation" class="in"></td>
                <td><label>Ø§Ù„Ù†Ø§Ø´Ø±</label><input type="text" id="publisher" class="in"></td>
                <td class="w-sm"><label>Ø·Ø¨Ø¹Ø©</label><input type="text" id="edition" class="in"></td>
                <td class="w-sm"><label>Ø³Ù†Ø©</label><input type="text" id="year" class="in"></td>
                <td class="w-sm"><label>ØµÙØ­Ø§Øª</label><input type="text" id="pages" class="in"></td>
            </tr>
            <tr>
                <td><label>Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label><input type="text" id="series" class="in"></td>
                <td><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ</label><input type="text" id="orig_title" class="in"></td>
                <td><label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="material_type" class="in"></td>
                <td colspan="3"><label>Ù…Ø­Ù‚Ù‚/Ù…Ø±Ø§Ø¬Ø¹Ø©</label><input type="text" id="editor" class="in"></td>
            </tr>
        </table>
        
        <div class="smart-zone">
            <span style="font-size:10px; font-weight:bold;">Ù„ØµÙ‚ Ø°ÙƒÙŠ:</span>
            <input type="text" id="smartInput" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ Ù…ÙØµÙˆÙ„Ø© Ø¨Ù€ (Ø›) Ø£Ùˆ (.) Ø«Ù… Ø§Ø¶ØºØ· ØªÙˆØ²ÙŠØ¹" style="height:20px; font-size:11px;">
            <button type="button" class="btn" style="background:#16a085; white-space:nowrap;" onclick="processSmart()">ØªÙˆØ²ÙŠØ¹ Ø°ÙƒÙŠ</button>
        </div>

        <div class="actions">
            <button type="button" id="saveBtn" class="btn" style="background:#27ae60" onclick="save()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="openBiblioWindow()">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (14pt ØºØ§Ù…Ù‚)</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="idx('author', 'Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†</button>
            <button type="button" class="btn" style="background:#d35400" onclick="idx('title', 'Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="idx('trans_idx', 'Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†</button>
            <button type="button" class="btn" style="background:#16a085" onclick="journalIdx()">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="idx('subject', 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª')">Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª</button>
        </div>
    </form>
</div>

<div id="modalOverlay"><button onclick="closeM()" class="close-fixed">Ø¥ØºÙ„Ø§Ù‚</button><div class="modal-content" id="modalBody"></div></div>

<div class="scroll-area"><table class="admin-table"><thead><tr><th>Ø±Ù‚Ù…</th><th>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="adminBody"></tbody></table></div>

<script>
let projs = JSON.parse(localStorage.getItem('L_P')) || ['Ù…Ø´Ø±ÙˆØ¹_1'];
let curP = localStorage.getItem('L_A') || 'Ù…Ø´Ø±ÙˆØ¹_1';
let recs = JSON.parse(localStorage.getItem('R_' + curP)) || [];
let editIndex = -1;
const cleanAL = (s) => s ? s.replace(/^(Ø§Ù„)/, '').trim() : '';

function draw() {
    recs.sort((a, b) => {
        let subC = cleanAL(a.subject).localeCompare(cleanAL(b.subject), 'ar');
        if (subC !== 0) return subC;
        return cleanAL(a.author).localeCompare(cleanAL(b.author), 'ar');
    });
    localStorage.setItem('R_' + curP, JSON.stringify(recs));
    localStorage.setItem('L_P', JSON.stringify(projs));
    localStorage.setItem('L_A', curP);
    let subs = [...new Set(recs.map(r => r.subject))];
    document.getElementById('subjectsList').innerHTML = subs.map(s => `<option value="${s}">`).join('');
    let hBody = '', entryCounter = 1;
    recs.forEach((r, i) => {
        let isRef = (r.see || r.see_also) && !r.title;
        let dNum = isRef ? '-' : entryCounter++;
        r.finalID = isRef ? null : dNum;
        hBody += `<tr><td>${dNum}</td><td>${r.subject}</td><td>${r.author || ''} - ${r.title || 'Ø¥Ø­Ø§Ù„Ø©'}</td><td><button class="btn btn-edit-row" onclick="edit(${i})">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-del-row" onclick="deleteRec(${i})">Ø­Ø°Ù</button></td></tr>`;
    });
    document.getElementById('adminBody').innerHTML = hBody;
    document.getElementById('pSel').innerHTML = projs.map(p=>`<option ${p===curP?'selected':''}>${p}</option>`).join('');
}

function processSmart() {
    let val = document.getElementById('smartInput').value;
    let pts = val.split(/[Ø›\.\|\-,]\s|Ø›/).map(p => p.trim()).filter(p => p.length > 0);
    const fields = ['author', 'author_preview', 'title', 'collab', 'translator', 'place', 'publisher', 'year', 'pages'];
    pts.forEach((v, i) => { if(fields[i]) document.getElementById(fields[i]).value = v; });
    document.getElementById('smartInput').value = "";
}

function save() {
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value.trim());
    if(!d.subject) return alert("Ø§Ù„Ø±Ø£Ø³ Ù…Ø·Ù„ÙˆØ¨");
    if (editIndex > -1) { recs[editIndex] = d; editIndex = -1; document.getElementById('saveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„"; } 
    else { recs.push(d); }
    draw(); document.getElementById('bForm').reset(); document.getElementById('subject').focus();
}

function edit(i) {
    editIndex = i; let r = recs[i];
    document.querySelectorAll('.in').forEach(inp => inp.value = r[inp.id] || '');
    document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„"; window.scrollTo(0,0);
}

function deleteRec(i) { if(confirm("Ø­Ø°ÙØŸ")) { recs.splice(i, 1); draw(); } }

function openBiblioWindow() {
    const win = window.open('', '_blank');
    let content = `<html dir="rtl"><head><title>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</title><style>body { font-family: 'Times New Roman', serif; padding: 40px; line-height: 1.6; font-size: 14pt; font-weight: bold; color: #000; } .preview-subject { background: #d1d1d1; text-align: center; padding: 5px; margin: 20px 0 10px 0; font-size: 16pt; border: 1px solid #000; } .entry { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; }</style></head><body>`;
    let lastSub = '';
    recs.forEach((r) => {
        if (r.subject !== lastSub) { content += `<div class="preview-subject">${r.subject}</div>`; lastSub = r.subject; }
        if (r.title) {
            let titleSep = (r.translator && !r.collab) ? " / " : ". - ";
            let resp = (r.author_preview || '') + (r.collab ? 'ØŒ ' + r.collab : '') + (r.translator ? (r.collab ? 'Ø› ØªØ±Ø¬Ù…Ø© ' : 'ØªØ±Ø¬Ù…Ø© ') + r.translator : '');
            let jData = r.journal ? (r.journal + (r.issue ? ' . Ù€Ù€Ù€ ' + r.issue : '')) : '';
            let pgStr = r.pages ? (r.journal ? 'Øµ ' + r.pages : r.pages + ' Øµ') : '';
            let end = (pgStr ? ". - " + pgStr : "") + (r.series ? " . Ù€Ù€Ù€ " + r.series : "") + (r.orig_title ? " . Ù€Ù€Ù€ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ: " + r.orig_title : "") + (r.material_type ? " . Ù€Ù€Ù€ " + r.material_type : "") + ".";
            content += `<div class="entry"><b>${r.author || ''} (${r.finalID})</b><br>${r.title}${titleSep}${resp}. - ${jData ? jData + ', ' : ''}${r.place ? r.place + ': ' : ''}${r.publisher ? r.publisher + ', ' : ''}${r.year ? r.year : ''}${end}</div>`;
        }
    });
    win.document.write(content + '</body></html>'); win.document.close();
}

function journalIdx() {
    let map = {};
    recs.forEach(r => { if(r.journal && r.finalID) { let key = r.journal + (r.affiliation ? ` (${r.affiliation})` : ""); if(!map[key]) map[key] = []; map[key].push(r.finalID); } });
    let h = `<h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª (ÙˆØ§Ù„ØªØ¨Ø¹ÙŠØ©)</h3><ul>`;
    Object.keys(map).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b),'ar')).forEach(k => { h += `<li><b>${k}</b> - (${map[k].join(', ')})</li>`; });
    document.getElementById('modalBody').innerHTML = h + '</ul>'; document.getElementById('modalOverlay').style.display='block';
}

function idx(f, t) {
    let map = {}; recs.forEach(r => { if(r[f] && r.finalID) r[f].split('/').forEach(p => { p=p.trim(); if(!map[p]) map[p]=[]; map[p].push(r.finalID); })});
    let h = `<h3>ÙƒØ´Ø§Ù ${t}</h3><ul>`; Object.keys(map).sort((a,b)=>cleanAL(a).localeCompare(cleanAL(b),'ar')).forEach(k => { h += `<li><b>${k}</b> (${map[k].join(', ')})</li>`; });
    document.getElementById('modalBody').innerHTML = h + '</ul>'; document.getElementById('modalOverlay').style.display='block';
}

function importX(e) {
    let f = e.target.files[0]; let rd = new FileReader();
    rd.onload = function(e) {
        let d = new Uint8Array(e.target.result); let wb = XLSX.read(d, {type:'array'});
        recs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); draw();
    }; rd.readAsArrayBuffer(f);
}

function exportX() { const ws = XLSX.utils.json_to_sheet(recs); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, `Fahras_${curP}.xlsx`); }
function closeM() { document.getElementById('modalOverlay').style.display='none'; }
function newP() { let n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:"); if(n) { projs.push(n); curP=n; recs=[]; draw(); } }
function switchP(v) { curP=v; recs=JSON.parse(localStorage.getItem('R_'+v))||[]; draw(); }
function delP() { if(confirm("Ø­Ø°ÙØŸ")) { localStorage.removeItem('R_'+curP); projs=projs.filter(p=>p!==curP); curP=projs[0]||'Ù…Ø´Ø±ÙˆØ¹_1'; draw(); } }
window.onload = draw;
</script>
</body>
</html>
