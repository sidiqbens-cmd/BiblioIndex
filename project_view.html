<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد - المحرر المتكامل</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; font-size: 13px; margin: 0; padding: 20px; }
        .compact-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .subject-header { grid-column: 1 / -1; background: #5a6268; color: #fff; padding: 8px; font-weight: bold; margin-top: 10px; border-radius: 4px; border-right: 5px solid #2ea44f; }
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 11px; color: #495057; margin-bottom: 2px; font-weight: bold; }
        input { border: 1px solid #ced4da; padding: 6px; border-radius: 4px; font-size: 13px; }
        input:focus { border-color: #2ea44f; outline: none; background: #f9fff9; }
        .actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: #007bff; }
        .btn-export { background: #28a745; }
        .preview-table { width: 100%; border-collapse: collapse; margin-top: 30px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .preview-table th, .preview-table td { border: 1px solid #dee2e6; padding: 10px; text-align: right; }
        .preview-table th { background: #e9ecef; color: #333; }
        .serial-col { width: 50px; text-align: center; font-weight: bold; }
        .subject-col { width: 200px; color: blue; font-weight: bold; }
    </style>
</head>
<body>

    <h2 style="color: #333; border-right: 5px solid #2ea44f; padding-right: 10px; margin-bottom: 20px;">نظام الفهرس الليبي الموحد</h2>
    
    <form id="biblioForm" class="compact-grid">
        <div class="subject-header">أولاً: البيانات الاستنادية والإحالات</div>
        <div class="field-group"><label>رأس الموضوع</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>إحالة انظر</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>إحالة انظر أيضاً</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>ملاحظة نطاق</label><input type="text" class="input-field"></div>

        <div class="subject-header">ثانياً: المسؤولية والبيان الببليوغرافي</div>
        <div class="field-group"><label>المؤلف</label><input type="text" class="input-field"></div>
        <div class="field-group" style="grid-column: span 2;"><label>العنوان</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>المؤلفون المشاركون (؛)</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>الطبعة</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>مكان النشر</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>الناشر</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>السنة</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>الصفحات</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>السلسلة</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>العنوان الأصلي</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>المؤلف الأصلي</label><input type="text" class="input-field"></div>

        <div class="subject-header" style="background: #868e96;">ثالثاً: الإحصاء والتبعية</div>
        <div class="field-group"><label>جهة الإصدار</label><input type="text" class="input-field"></div>
        <div class="field-group"><label>عدد المؤلفين</label><input type="number" class="input-field"></div>
        <div class="field-group" style="grid-column: span 2;"><label>التبعية المؤسسية</label><input type="text" class="input-field"></div>
    </form>

    <div class="actions">
        <button type="button" class="btn btn-save" onclick="saveRecord()">حفظ السجل (Enter)</button>
        <button type="button" class="btn btn-export" onclick="exportToCSV()">تصدير إلى Excel (CSV)</button>
    </div>

    <div id="displayArea">
        <h3 style="margin-top:40px; color: #5a6268;">المعاينة المباشرة (مرتبة هجائياً)</h3>
        <table class="preview-table">
            <thead>
                <tr>
                    <th class="serial-col">ت</th>
                    <th class="subject-col">رأس الموضوع</th>
                    <th>البيان الببليوغرافي</th>
                </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
        </table>
    </div>

<script>
    let records = JSON.parse(localStorage.getItem('libyan_records')) || [];

    function saveRecord() {
        const fields = document.querySelectorAll('.input-field');
        const data = {
            subject: fields[0].value,
            author: fields[4].value,
            title: fields[5].value,
            year: fields[10].value,
            publisher: fields[9].value,
            place: fields[8].value
        };

        if(!data.subject || !data.title) {
            alert("يرجى إدخال رأس الموضوع والعنوان على الأقل");
            return;
        }

        records.push(data);
        
        // الترتيب بتجاهل "الـ" التعريف
        records.sort((a, b) => {
            const clean = (t) => t.replace(/^ال/, "").trim();
            return clean(a.subject).localeCompare(clean(b.subject), 'ar');
        });

        localStorage.setItem('libyan_records', JSON.stringify(records));
        renderTable();
        document.getElementById('biblioForm').reset();
        fields[0].focus();
    }

    function renderTable() {
        const body = document.getElementById('recordsBody');
        body.innerHTML = '';
        let serial = 1; // الترقيم يبدأ من 1

        records.forEach((rec, index) => {
            const row = `<tr>
                <td class="serial-col">${serial + index}</td>
                <td class="subject-col">${rec.subject}</td>
                <td>${rec.author}. ${rec.title}. - ${rec.place}: ${rec.publisher}, ${rec.year}</td>
            </tr>`;
            body.innerHTML += row;
        });
    }

    function exportToCSV() {
        if(records.length === 0) { alert("لا توجد سجلات لتصديرها"); return; }
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "ت,رأس الموضوع,المؤلف,العنوان,المكان,الناشر,السنة\n";
        records.forEach((rec, index) => {
            csvContent += `${index + 1},"${rec.subject}","${rec.author}","${rec.title}","${rec.place}","${rec.publisher}","${rec.year}"\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "الفهرس_الليبي_الموحد.csv");
        document.body.appendChild(link);
        link.click();
    }

    // التنقل بـ Enter
    document.querySelectorAll('.input-field').forEach((input, index, list) => {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (index < list.length - 1) list[index+1].focus();
                else saveRecord();
            }
        });
    });

    window.onload = renderTable;
</script>

</body>
</html>
