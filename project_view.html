<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceef1; margin: 0; padding: 0; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; padding: 2px 0; border-bottom: 2px solid #000; }
        .input-table { width: 100%; background: #cfcfcf; border-spacing: 4px; padding: 2px; table-layout: fixed; }
        label { font-size: 9px; font-weight: bold; color: #333; display: block; text-align: center; margin-bottom: 1px; white-space: nowrap; }
        input { width: 100%; height: 18px; font-size: 10px; border: 1px solid #999; border-radius: 2px; padding: 0 3px; box-sizing: border-box; text-align: right; }
        .actions { background: #cfcfcf; text-align: center; padding: 5px; border-bottom: 2px solid #2c3e50; display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
        .btn { padding: 3px 10px; cursor: pointer; border: none; border-radius: 3px; color: #fff; font-size: 9px; font-weight: bold; }
        .scroll-area { margin-top: 170px; padding: 10px; }
        .preview-table { width: 100%; border-collapse: collapse; background: #fff; }
        .preview-table td { border: 1px solid #ccc; padding: 6px; font-size: 11px; text-align: right; vertical-align: top; }
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; overflow-y:auto; }
        .modal-content { background:white; width:90%; margin:20px auto; padding:20px; border-radius:5px; position:relative; min-height:80vh; }
        .close-btn { position:sticky; top:0; float:left; background:#c0392b; color:white; border:none; padding:5px 15px; cursor:pointer; font-weight:bold; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="display:flex; justify-content:space-between; align-items:center; background:#34495e; color:white; padding:4px 15px;">
        <strong style="font-size:12px;">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</strong>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="document.getElementById('fileInput').click()" class="btn" style="background:#e67e22">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="fileInput" style="display:none" accept=".xlsx, .xls" onchange="importExcel(event)">
            
            <div style="border-right:1px solid #555; height:15px; margin:0 5px;"></div>
            
            <button onclick="newProject()" class="btn" style="background:#27ae60">+ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
            <select id="projSelect" onchange="switchProject(this.value)" style="font-size:10px; height:18px;"></select>
            <button onclick="deleteProject()" class="btn" style="background:#c0392b">Ø­Ø°Ù</button>
        </div>
    </div>

    <form id="biblioForm">
        <table class="input-table">
            <tr>
                <td><label>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label><input type="text" id="subject" class="in"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø±</label><input type="text" id="see" class="in"></td>
                <td><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹</label><input type="text" id="see_also" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù…Ù‚Ù„ÙˆØ¨)</label><input type="text" id="author" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="author_preview" class="in"></td>
                <td><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="title" class="in"></td>
            </tr>
            <tr>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="collab" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="collab_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="translator" class="in"></td>
                <td><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="trans_idx" class="in"></td>
                <td><label>Ø§Ù„Ù…Ø¬Ù„Ø©</label><input type="text" id="journal" class="in"></td>
                <td><label>Ø§Ù„Ù†Ø§Ø´Ø±</label><input type="text" id="publisher" class="in"></td>
            </tr>
            <tr>
                <td><label>Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø´Ø±</label><input type="text" id="place" class="in"></td>
                <td><label>Ø§Ù„ØªØ¨Ø¹ÙŠØ©/Ø§Ù„Ø¬Ù‡Ø©</label><input type="text" id="affiliation" class="in"></td>
                <td><label>Ù…Ø­Ù‚Ù‚/Ù…Ø±Ø§Ø¬Ø¹Ø©</label><input type="text" id="editor" class="in"></td>
                <td><label>Ø¹Ù†ÙˆØ§Ù† Ø£ØµÙ„ÙŠ</label><input type="text" id="orig_title" class="in"></td>
                <td><label>Ø§Ù„Ø³Ù†Ø©</label><input type="text" id="year" class="in"></td>
                <td><label>ØµÙØ­Ø§Øª</label><input type="text" id="pages" class="in"></td>
            </tr>
        </table>
        <div class="actions">
            <button type="button" class="btn" style="background:#27ae60" onclick="saveRecord()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="showFullPreview()">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="showIndex('author', 'ÙƒØ´Ø§Ù Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†</button>
            <button type="button" class="btn" style="background:#d35400" onclick="showIndex('title', 'ÙƒØ´Ø§Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</button>
            <button type="button" class="btn" style="background:#c0392b" onclick="showIndex('trans_idx', 'ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†')">ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†</button>
            <button type="button" class="btn" style="background:#16a085" onclick="showIndex('journal', 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="showIndex('subject', 'Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª')">Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª</button>
        </div>
    </form>
</div>

<div id="modalOverlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        <h2 id="modalTitle" style="text-align:center;"></h2>
        <div id="modalBody"></div>
    </div>
</div>

<div class="scroll-area">
    <table class="preview-table"><tbody id="tableBody"></tbody></table>
</div>

<script>
let projects = JSON.parse(localStorage.getItem('LBY_PROJS')) || ['Ù…Ø´Ø±ÙˆØ¹_1'];
let currentP = localStorage.getItem('LBY_ACTIVE') || 'Ù…Ø´Ø±ÙˆØ¹_1';
let records = JSON.parse(localStorage.getItem('RECS_' + currentP)) || [];

function update() {
    localStorage.setItem('RECS_' + currentP, JSON.stringify(records));
    localStorage.setItem('LBY_PROJS', JSON.stringify(projects));
    localStorage.setItem('LBY_ACTIVE', currentP);
    
    let h = ''; let count = 1;
    records.forEach((r, i) => {
        h += `<tr>
            <td width="30">${r.title ? count++ : '-'}</td>
            <td width="150"><strong>${r.subject || ''}</strong></td>
            <td>
                ${r.see ? `<span style="color:red">Ø§Ù†Ø¸Ø±: ${r.see}</span>` : ''}
                ${r.author_preview ? `<b>${r.author_preview}</b>. ` : ''}${r.title || ''}
            </td>
            <td width="50"><button onclick="editRec(${i})">ØªØ¹Ø¯ÙŠÙ„</button></td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = h;
    document.getElementById('projSelect').innerHTML = projects.map(p=>`<option ${p===currentP?'selected':''}>${p}</option>`).join('');
}

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
function importExcel(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type: 'binary'});
        const sheetName = wb.SheetNames[0];
        const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
        
        if(confirm(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.length} Ø³Ø¬Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ`)) {
            records = [...records, ...data];
            records.sort((a,b) => String(a.subject).localeCompare(String(b.subject), 'ar'));
            update();
        }
    };
    reader.readAsBinaryString(file);
}

function saveRecord() {
    let d = {}; document.querySelectorAll('.in').forEach(i => d[i.id] = i.value);
    if(!d.subject) return alert("Ø§Ù„Ø±Ø£Ø³ Ù…Ø·Ù„ÙˆØ¨");
    records.push(d);
    records.sort((a,b) => String(a.subject).localeCompare(String(b.subject), 'ar'));
    update();
    document.getElementById('biblioForm').reset();
}

function editRec(i) {
    let r = records[i];
    Object.keys(r).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = r[k]; });
    records.splice(i, 1);
    update();
}

function newProject() {
    let n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
    if(n) { projects.push(n); currentP = n; records = []; update(); }
}

function switchProject(v) {
    currentP = v;
    records = JSON.parse(localStorage.getItem('RECS_' + v)) || [];
    update();
}

function deleteProject() {
    if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ")) {
        localStorage.removeItem('RECS_' + currentP);
        projects = projects.filter(p => p !== currentP);
        currentP = projects[0] || 'Ù…Ø´Ø±ÙˆØ¹_1';
        records = JSON.parse(localStorage.getItem('RECS_' + currentP)) || [];
        update();
    }
}

function showIndex(field, title) {
    document.getElementById('modalTitle').innerText = title;
    let list = records.map(r => r[field]).filter(v => v && String(v).trim() !== "");
    let unique = [...new Set(list)].sort((a,b) => String(a).localeCompare(String(b), 'ar'));
    document.getElementById('modalBody').innerHTML = `<ul style="columns:2">${unique.map(x=>`<li>${x}</li>`).join('')}</ul>`;
    document.getElementById('modalOverlay').style.display = 'block';
}

window.onload = update;
</script>
</body>
</html>
