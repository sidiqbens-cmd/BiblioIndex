<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eceef1; color: #333; margin: 0; padding: 0; font-size: 12px; line-height: 1.2; overflow: hidden; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #2c3e50; z-index: 1000; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .project-bar { color: #fff; padding: 5px 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px; }
        .compact-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; background: #CFCFCF; padding: 15px; border-bottom: 2px solid #aaa; }
        label { font-size: 11px; font-weight: bold; color: #444; text-align: right; display: block; margin-bottom: 3px; }
        input, select { width: 100%; border: 1px solid #999; padding: 4px 6px; font-size: 12px; height: 28px; text-align: right; border-radius: 3px; box-sizing: border-box; background: #E6E6E6; }
        .year-shift { margin-right: auto; padding-right: 15px; }
        .scroll-content { margin-top: 275px; height: calc(100vh - 275px); overflow-y: auto; padding: 10px; }
        .actions { margin: 0; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; background: #CFCFCF; padding: 5px 0 10px 0; }
        .btn { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; color: #fff; font-weight: bold; font-size: 11px; }
        .btn-save { background: #27ae60; padding: 8px 20px; font-size: 12px; }
        .preview-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; }
        .preview-table td { border: 1px solid #ccc; padding: 5px; text-align: right; font-size: 12px; line-height: 1.4; }
        .subject-bg { background: #dcdcdc; color: #000; font-weight: bold; padding: 2px 8px; border-radius: 2px; display: inline-block; }
        .ref-bg { background: #f2f2f2; color: #000; padding: 2px 8px; border-radius: 2px; width: 100%; display: block; text-align: center; margin: 2px 0; }
        .short-in { width: 65px !important; display: block; margin: 0 auto; }
        .btn-t { padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; border: 1px solid #ccc; background: #f8f9fa; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div class="project-bar">
        <div><strong>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</strong> | <span id="activeProjectLabel"></span></div>
        <div style="display:flex; gap:8px;">
            <button onclick="document.getElementById('fileInput').click()" class="btn" style="background:#e67e22">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
            <input type="file" id="fileInput" style="display:none" onchange="importExcel(event)">
            <button onclick="createNewProject()" class="btn" style="background:#2980b9">+ Ø¬Ø¯ÙŠØ¯</button>
            <select id="projSelect" onchange="switchProject(this.value)" style="height:25px; font-size:11px; width:100px;"></select>
        </div>
    </div>

    <form id="biblioForm">
        <div class="compact-grid">
            <div><label>Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label><input type="text" id="subject" class="in" list="subList"></div>
            <div><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø±</label><input type="text" id="see" class="in" list="subList"></div>
            <div><label>Ø¥Ø­Ø§Ù„Ø© Ø§Ù†Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹</label><input type="text" id="see_also" class="in" list="subList"></div>
            <div><label>Ø§Ù„Ù…Ø¤Ù„Ù (Ù…Ù‚Ù„ÙˆØ¨)</label><input type="text" id="author" class="in"></div>
            <div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="title" class="in"></div>
            <div><label>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="collab" class="in"></div>
            <div><label>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="collab_idx" class="in"></div>
            <div><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)</label><input type="text" id="translator" class="in"></div>
            <div><label>Ø§Ù„Ù…ØªØ±Ø¬Ù… (Ù„Ù„ÙƒØ´Ø§Ù)</label><input type="text" id="trans_idx" class="in"></div>
            <div><label>Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø´Ø±</label><input type="text" id="place" class="in"></div>
            <div><label>Ø§Ù„Ù†Ø§Ø´Ø± / Ø§Ù„Ù…Ø¬Ù„Ø©</label><input type="text" id="publisher" class="in"></div>
            <div><label>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„Ù…Ø¬Ù„Ø¯</label><input type="text" id="issue" class="in short-in"></div>
            <div class="year-shift"><label>Ø§Ù„Ø³Ù†Ø©</label><input type="text" id="year" class="in short-in"></div>
            <div><label>Ù…Ø­Ù‚Ù‚/Ù…Ø±Ø§Ø¬Ø¹Ø©</label><input type="text" id="editor" class="in"></div>
            <div><label>ØµÙØ­Ø§Øª</label><input type="text" id="pages" class="in short-in"></div>
            <div><label>Ø§Ù„Ø·Ø¨Ø¹Ø©</label><input type="text" id="edition" class="in short-in"></div>
            <div><label>Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label><input type="text" id="series" class="in"></div>
            <div><label>Ø¹Ù†ÙˆØ§Ù† Ø£ØµÙ„ÙŠ</label><input type="text" id="orig_title" class="in"></div>
        </div>
        <div class="actions">
            <button type="button" class="btn btn-save" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button type="button" class="btn" style="background:#2980b9" onclick="exportToExcel()">Excel</button>
            <button type="button" class="btn" style="background:#8e44ad" onclick="previewFullList()">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button type="button" class="btn" style="background:#555" onclick="previewAuthorIndex()">ÙƒØ´Ø§Ù Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ†</button>
            <button type="button" class="btn" style="background:#d43f3a" onclick="previewIndex('title')">ÙƒØ´Ø§Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</button>
            <button type="button" class="btn" style="background:#555" onclick="previewIndex('trans_idx')">ÙƒØ´Ø§Ù Ø§Ù„Ù…ØªØ±Ø¬Ù…ÙŠÙ†</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="previewSubjectList()">Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª</button>
            <button type="button" class="btn" style="background:#2c3e50" onclick="previewJournalList()">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø§Øª</button>
        </div>
    </form>
</div>

<div class="scroll-content">
    <table class="preview-table"><tbody id="tableBody"></tbody></table>
</div>

<script>
let projects = JSON.parse(localStorage.getItem('p_list')) || ['Ø§Ù„Ù…Ø´Ø±ÙˆØ¹_1'];
let currentProj = localStorage.getItem('p_active') || 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹_1';
let records = JSON.parse(localStorage.getItem('recs_' + currentProj)) || [];
let editIdx = -1;

const cln = (s) => { if (!s) return ""; let str = String(s).trim(); str = str.replace(/^Ø§Ù„(?=[^Ù„])/, "").replace(/Ø¢/g, "Ø§Ø§").replace(/[Ø£Ø¥Ø¢]/g, "Ø§").replace(/Ù‰/g, "ÙŠ"); return str; };

// --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© ØªÙ…Ø§Ù…Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± ÙˆØ¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ Ø£Ù‚ÙˆØ§Ø³) ---
function buildBiblioPart(r) {
    if(!r.title) return "";
    let b = r.title;
    
    if (r.collab || r.translator) {
        b += " / ";
        if (r.collab && r.collab.trim() !== "") {
            b += r.author + " ØŒ " + r.collab;
        } else {
            b += r.author;
        }
        if (r.translator && r.translator.trim() !== "") {
            b += " Ø› ØªØ±Ø¬Ù…Ø© " + r.translator;
        }
    } else {
        b += " . Ù€Ù€Ù€ ";
    }

    if(r.editor) b += " Ø› " + r.editor;
    if(r.edition) b += " . - Ø· " + r.edition;

    b += " . - ";
    if(r.place) { 
        b += r.place + ": " + r.publisher; 
    } else { 
        b += r.publisher; 
    }

    if(r.issue) b += "ØŒ Ø¹ " + r.issue;
    if(r.year) b += "ØŒ " + r.year;
    b += ". Ù€Ù€Ù€";
    
    if(r.pages) b += " " + r.pages;
    if(r.series) b += " . - (" + r.series + ")";
    if(r.orig_title) b += "<br><div style='text-align:left; direction:ltr;'>" + r.orig_title + "</div>";
    
    return b;
}

function formatNumbers(nums) {
    if (nums.length <= 3) return nums.join(', ');
    let sorted = nums.map(Number).sort((a, b) => a - b);
    let isSequential = true;
    for (let i = 1; i < sorted.length; i++) {
        if (sorted[i] !== sorted[i-1] + 1) { isSequential = false; break; }
    }
    return isSequential ? `${sorted[0]}-${sorted[sorted.length-1]}` : sorted.join(', ');
}

function updateUI() {
    localStorage.setItem('recs_'+currentProj, JSON.stringify(records));
    let h = ''; let s = 1; let subs = new Set();
    records.forEach((r, i) => {
        subs.add(r.subject);
        let isBook = !!r.title && !r.see;
        h += `<tr>
            <td style="text-align:center; width:35px; font-weight:bold;">${isBook ? s++ : '--'}</td>
